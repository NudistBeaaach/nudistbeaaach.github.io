<!DOCTYPE html>
<html lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta
    name="description"
    content="Author: Kien Nguyen <kiennt2609@gmail.com>
      A minimal Hugo theme with Tailwind CSS"
  />
  <title>
    
      Blog de TaylorDeDordogne
      | V√©locip√®de M√©canique
    
  </title>
  <meta name="author" content="map[email:taylordedordogne@gmail.com name:TaylorDeDordogne]" />
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <link
    rel="icon"
    href="/favicon_io/favicon.ico"
    type="image/x-icon"
  />
  <link
    rel="icon"
    href="/favicon_io/favicon-16x16.png"
    size="16x16"
    type="image/png"
  />
  <link
    rel="icon"
    href="/favicon_io/favicon-32x32.png"
    size="32x32"
    type="image/png"
  />

  <link
    rel="preload"
    type="text/css"
    href="/css/rose-pine.min.css"
    integrity=""
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript>
    <link
      rel="stylesheet"
      type="text/css"
      href="/css/rose-pine.min.css"
      integrity=""
    />
  </noscript><link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Overpass+Mono:wght@400;500;700&family=Overpass:wght@400;500;700&display=swap"
  rel="stylesheet"
/>
<link
    rel="preload"
    type="text/css"
    href="/css/toigian.css"
    integrity=""
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript>
    <link
      rel="stylesheet"
      type="text/css"
      href="/css/toigian.css"
      integrity=""
    />
  </noscript>

  
  <link
    rel="stylesheet"
    type="text/css"
    href="/css/light.css"
    integrity=""
  />
  <link
    rel="stylesheet"
    type="text/css"
    href="/css/dark.css"
    integrity=""
  />

  <script>
    
    if (
      localStorage.theme === "dark" ||
      (!("theme" in localStorage) &&
        window.matchMedia("(prefers-color-scheme: dark)").matches)
    ) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  </script>

  
  
  <script
    async
    defer
    src="/js/main.js"
    integrity=""
  ></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: true, securityLevel: "loose" });
  </script>
  
  
</head>
<body><header style="--layer: 10">
  <div
    aria-hidden="true"
    class="absolute top-[-1000px] left-0 z-[calc(var(--layer)+1)] h-[calc(1000px+var(--page-top))] w-full bg-base"
  ></div>

  <div
    class="fixed top-0 left-0 z-[var(--layer)] flex h-header-height w-full items-center border-b px-page-gutter before:absolute before:inset-0 before:z-[-1] before:bg-base [@supports(backdrop-filter:blur(0))]:before:bg-base [@supports(backdrop-filter:blur(0))]:before:backdrop-blur-md"
  ><div
  class="lowercase italic mx-auto flex w-full max-w-content items-center justify-between"
>
  <nav>
    <ol class="flex text-md items-center">
      
  
    
  
    
  
  
  
  <li>
    
    
    <a href="/" class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">Blog de TaylorDeDordogne</a>
  </li>
  
    <li class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">/</li>
  

  
  
  
  <li>
    
    
    <a href="/write-ups/" class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">Write Ups</a>
  </li>
  
    <li class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">/</li>
  

  
  
  
    
  
  <li>
    
    
    <a href="/write-ups/v%C3%A9locip%C3%A8de-m%C3%A9canique/" class="focus:underline focus:outline-none font-bold after:md:mx-2 after:mx-0.5">V√©locip√®de M√©canique</a>
  </li>
  

    </ol>
  </nav>
  <nav>
    <a href="http://localhost:1313//index.xml"
      ><svg
        width="18px"
        height="18px"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"
        />
      </svg>
    </a>
  </nav>
</div>


</div>
</header>
<main class="flex justify-center px-page-gutter py-page-top">
      <div class="min-h-content w-full max-w-content space-y-10 sm:space-y-20"><div
  class="lowercase italic mx-auto flex w-full max-w-content items-center justify-between"
>
  <nav>
    <ol class="flex text-md items-center">
      
  
    
  
    
  
  
  
  <li>
    
    
    <a href="/" class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">Blog de TaylorDeDordogne</a>
  </li>
  
    <li class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">/</li>
  

  
  
  
  <li>
    
    
    <a href="/write-ups/" class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">Write Ups</a>
  </li>
  
    <li class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">/</li>
  

  
  
  
    
  
  <li>
    
    
    <a href="/write-ups/v%C3%A9locip%C3%A8de-m%C3%A9canique/" class="focus:underline focus:outline-none font-bold after:md:mx-2 after:mx-0.5">V√©locip√®de M√©canique</a>
  </li>
  

    </ol>
  </nav>
  <nav>
    <a href="http://localhost:1313//index.xml"
      ><svg
        width="18px"
        height="18px"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"
        />
      </svg>
    </a>
  </nav>
</div>


<article>
  <h1>V√©locip√®de M√©canique</h1>
  <time class="text-sm italic tabular-nums text-muted"
  >2023/06/09&nbsp;</time
>

  

  
    <div class="section">
      
        
        <a href="/tags/re/" id="tag">RE</a>
      
        
        <a href="/tags/404ctf-2023/" id="tag">404CTF 2023</a>
      
    </div>
  


<div id="toc">
  
    
      <details open>
        <summary>Table of contents</summary>
        <div id="toc-list"><nav id="TableOfContents">
  <ol>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#mettre-en-place-qiling">Mettre en place qiling</a></li>
    <li><a href="#analyse-statique">Analyse statique</a>
      <ol>
        <li><a href="#analyse-de-la-fonction-main">Analyse de la fonction main</a></li>
        <li><a href="#analyse-de-la-fonction-vm_start">Analyse de la fonction vm_start</a></li>
        <li><a href="#analyse-de-la-fonction-find_symbol">Analyse de la fonction find_symbol</a></li>
        <li><a href="#analyse-du-dispacher-de-la-vm">Analyse du dispacher de la VM</a></li>
      </ol>
    </li>
    <li><a href="#tracing-de-la-vm-avec-qiling">Tracing de la VM avec Qiling</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ol>
</nav></div>
      </details>
    
  
</div>
<div class="content"><h2 id="introduction">Introduction</h2>
<p>Ce challenge faisait partie de la cat√©gorie Reverse, l&rsquo;√©nonc√© se pr√©sentait comme ceci:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">En vagabondant dans le caf√©, vous rencontrez le myst√©rieux Balzac. Il vous appelle dans un coin discret et vous tend une bo√Æte √©trange. Il vous dit que c&#39;est une &#34;VM&#34;, ou &#34;V√©locip√®de M√©canique&#34;, une machine de fabrication √©trang√®re qui ressemble √† une machine √† √©crire, mais qui semble bien plus avanc√©e.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Il vous tend √©galement une feuille qu&#39;il appelle un &#34;programme&#34;. Il vous explique que si vous ins√©rez cette feuille dans la machine, elle d√©clenche un comportement particulier. Vous √™tes fascin√© par cette myst√©rieuse machine et vous vous demandez ce qu&#39;elle pourrait bien faire.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Balzac vous demande de l&#39;√©tudier et d&#39;essayer de d√©couvrir tous ses secrets. C&#39;est un honneur qu&#39;il vous fasse confiance pour cette mission, mais vous ne savez pas encore par o√π commencer.
</span></span></code></pre></div><p>Deux fichiers √©taient fournis avec √ßa: <code>vm</code> et <code>reverse_my_vm.vmr</code>. Il s&rsquo;agit donc d&rsquo;une machine virtuelle, et on a le programme qui sera ex√©cut√© par cette derni√®re. Par la suite on verra que cette VM impl√©mente relativement peu d&rsquo;instructions, par cons√©quent ca ne devrais pas √™tre trop difficile donc autant le solve d&rsquo;une mani√®re intelligente (histoire de pouvoir quand m√™me en tirer quelque chose de nouveau üôÇ)!
<br>
C&rsquo;est pourquoi au lieu de coder un simple d√©sasembleur ou d&rsquo;utiliser l&rsquo;ex√©cution symbolique on va utiliser <a href="https://qiling.io">Qiling</a>, un framework d&rsquo;√©mulation bas√© sur <code>Unicorn</code> qui va nous permettre de r√©cup√©rer une <code>trace</code> d&rsquo;ex√©cution de la VM.</p>
<p>Mais tout d&rsquo;abord on peut lancer le programme une premi√®re fois, on doit lui fournir son script en argument:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./vm reverse_my_vm.vmr 
</span></span><span class="line"><span class="cl">Please enter the key: <span class="nb">test</span>
</span></span><span class="line"><span class="cl">Error: Function <span class="s2">&#34;check_key&#34;</span> not found
</span></span></code></pre></div><p>Ok&hellip; C&rsquo;est assez bizarre mais bon, pour l&rsquo;instant on va d√©j√† voir comment faire fonctionner Qiling!ü§°</p>
<h2 id="mettre-en-place-qiling">Mettre en place qiling</h2>
<p>Une fois apr√®s avoir install√© Qiling, on essaye d&rsquo;√©muler le programme de cette mani√®re:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">ql</span> <span class="o">=</span> <span class="n">Qiling</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;/home/mitenka/Bureau/CTF_TEMP/404_CTF/RE/vm&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;/home/mitenka/Bureau/CTF_TEMP/404_CTF/RE/reverse_my_vm.vmr&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;qiling/examples/rootfs/x8664_linux&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">verbose</span><span class="o">=</span><span class="n">QL_VERBOSE</span><span class="o">.</span><span class="n">DEFAULT</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ql</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><p>les arguments que prennent le constructeur <code>Qiling</code> sont:</p>
<ul>
<li>Une liste faisant office de <code>argv</code></li>
<li>Le <code>rootfs</code> sur lequel lancer l&rsquo;ex√©cutable, qiling fournis des dossiers servant de racine pour √©muler le programme.</li>
<li>Des arguments suppl√©mentaires pour sp√©cifier la verbosit√© par exemple.</li>
</ul>
<p>Ok on lance le script, et&hellip;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/home/mitenka/Bureau/CTF_TEMP/404_CTF/RE/vm: /lib/libc.so.6: version <span class="sb">`</span>GLIBC_2.34<span class="err">&#39;</span> not found <span class="o">(</span>required by /home/mitenka/Bureau/CTF_TEMP/404_CTF/RE/vm<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[=]</span>     writev<span class="o">(</span><span class="nv">fd</span> <span class="o">=</span> 0x2, <span class="nv">vec</span> <span class="o">=</span> 0x80000000d480, <span class="nv">vlen</span> <span class="o">=</span> 0x6<span class="o">)</span> <span class="o">=</span> 0x96
</span></span><span class="line"><span class="cl"><span class="o">[=]</span>     mmap<span class="o">(</span><span class="nv">addr</span> <span class="o">=</span> 0x0, <span class="nv">length</span> <span class="o">=</span> 0x2000, <span class="nv">prot</span> <span class="o">=</span> 0x3, <span class="nv">flags</span> <span class="o">=</span> 0x22, <span class="nv">fd</span> <span class="o">=</span> 0xffffffff, <span class="nv">pgoffset</span> <span class="o">=</span> 0x0<span class="o">)</span> <span class="o">=</span> 0x7fffb81c7000
</span></span><span class="line"><span class="cl"><span class="o">[=]</span>     exit_group<span class="o">(</span><span class="nv">code</span> <span class="o">=</span> 0x1<span class="o">)</span> <span class="o">=</span> ?
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     CPU Context:
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     ah    : 0x0
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     al    : 0xe7
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     ch    : 0x0
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     cl    : 0x0
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     dh    : 0xda
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     dl    : 0xc0
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     bh    : 0x0
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     bl    : 0x0
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     ax    : 0xe7
</span></span></code></pre></div><p>On se prend une grosse erreur, c&rsquo;est du au fait que le la version propos√©e de la libc par le rootfs <code>x8664_linux</code>, n&rsquo;est pas celle attendue par le binaire, pour r√©gler ce probl√®me on peut utiliser notre propre filesystem (ma libc √©tant la <code>2.35</code>). Et cette fois ci on se prend une erreur diff√©rente:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/lib/x86_64-linux-gnu/libc.so.6: CPU ISA level is lower than required
</span></span><span class="line"><span class="cl"><span class="o">[=]</span>     writev<span class="o">(</span><span class="nv">fd</span> <span class="o">=</span> 0x2, <span class="nv">vec</span> <span class="o">=</span> 0x80000000d490, <span class="nv">vlen</span> <span class="o">=</span> 0x2<span class="o">)</span> <span class="o">=</span> 0x46
</span></span><span class="line"><span class="cl"><span class="o">[=]</span>     exit_group<span class="o">(</span><span class="nv">code</span> <span class="o">=</span> 0x7f<span class="o">)</span> <span class="o">=</span> ?
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     CPU Context:
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     ah    : 0x0
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     al    : 0xe7
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     ch    : 0x0
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     cl    : 0x0
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     dh    : 0xd8
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     dl    : 0xd0
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     bh    : 0x0
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     bl    : 0x0
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span>     ax    : 0xe7
</span></span></code></pre></div><p>√âtant donn√© que Qiling fait de l&rsquo;√©mulation √† la diff√©rence des frameworks de <code>DBI</code>, l&rsquo;architecture du processeur √©mul√© n&rsquo;a pas l&rsquo;air d&rsquo;√™tre consid√©r√©e comme reconaissable par le linker dynamique de la <code>2.35</code>. J&rsquo;ai trouv√© <a href="https://github.com/qilingframework/qiling/issues/1201#issuecomment-1273779633">ici</a> comment r√©soudre ce probl√®me, on va hijack le code dans le linker dynamique qui effectue le check:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Patching ld-2.35.so ISA check</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">by_pass_isa_check</span><span class="p">(</span><span class="n">ql</span><span class="p">:</span> <span class="n">Qiling</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">ql</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="s1">&#39;=-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}</span><span class="s2">[Bypassing isa check]</span><span class="si">{</span><span class="s1">&#39;=-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ql</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">rip</span> <span class="o">+=</span> <span class="mh">0x15</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ld_so_base</span> <span class="o">=</span> <span class="mh">0x7FFFF7DD5000</span>
</span></span><span class="line"><span class="cl"><span class="n">ql</span><span class="o">.</span><span class="n">hook_address</span><span class="p">(</span><span class="n">by_pass_isa_check</span><span class="p">,</span> <span class="n">ld_so_base</span> <span class="o">+</span> <span class="mh">0x2389F</span><span class="p">)</span>
</span></span></code></pre></div><p>Et pour finir, dans cette <a href="https://github.com/qilingframework/qiling/issues/1349#issuecomment-1556932986">r√©ponse</a>, un des dev de qiling parle du fait que les processeurs √©mul√©s par <code>Unicorn</code> ne supportent pas encore le <code>CET</code> (<code>Control-flow Enforcement Technology</code>) et que malheureusement le syscall <code>prctl</code> renvoie OK dans tous les cas m√™me si le CET n&rsquo;est pas support√© donc pour √©viter que la libc essaye d&rsquo;activer tout de m√™me le CET on va aussi hijack le syscall prctl:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># patching prctl code 0x3001 not found</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">__no_cet</span><span class="p">(</span><span class="n">ql</span><span class="p">:</span> <span class="n">Qiling</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">retval</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ql</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="s1">&#39;=-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}</span><span class="s2">[Bypassig prctl CET missing]</span><span class="si">{</span><span class="s1">&#39;=-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="c1"># intercept arch_prctl syscall after it exits. if code was set to ARCH_CET_STATUS,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># then return an error value. otherwise, return the value originally returned by</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># the syscall.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># note: if -1 doesn&#39;t work, maybe should use -22 (-EINVAL) instea</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mh">0x3001</span> <span class="k">else</span> <span class="n">retval</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ql</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">set_syscall</span><span class="p">(</span><span class="s1">&#39;arch_prctl&#39;</span><span class="p">,</span> <span class="n">__no_cet</span><span class="p">,</span> <span class="n">QL_INTERCEPT</span><span class="o">.</span><span class="n">EXIT</span><span class="p">)</span>
</span></span></code></pre></div><p>Et vu que je me prenais aussi un warning au niveau du syscall <code>rseq</code>, j&rsquo;ai trouv√© une solution sur un <a href="https://eqqie.cn/index.php/archives/2015">blog chinois</a>, je n&rsquo;ai pas eu la foi d&rsquo;aller chercher les raisons de ce bug ci mais il nous suffit de rajouter ceci pour que le warning disparaisse:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Patching rseq not found</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">null_rseq_impl</span><span class="p">(</span><span class="n">ql</span><span class="p">:</span> <span class="n">Qiling</span><span class="p">,</span> <span class="n">abi</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sig</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">ql</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="s1">&#39;=-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}</span><span class="s2">[Bypassing rseq not found]</span><span class="si">{</span><span class="s1">&#39;=-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ql</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">set_syscall</span><span class="p">(</span><span class="s2">&#34;rseq&#34;</span><span class="p">,</span> <span class="n">null_rseq_impl</span><span class="p">,</span> <span class="n">QL_INTERCEPT</span><span class="o">.</span><span class="n">CALL</span><span class="p">)</span>
</span></span></code></pre></div><p>Et finalement&hellip; Ca marche! On va passer maintenant √† l&rsquo;analyse statique avant d&rsquo;instrumenter le tout avec notre Qiling fonctionnel üòÄ!</p>
<h2 id="analyse-statique">Analyse statique</h2>
<p>le binaire est donc un ELF 64 bits, link√© dynamiquement et stripp√©. On l&rsquo;ouvre dans <code>Binary Ninja</code> et on tombe sur la fonction main, le programme semble √™tre cod√© en C:</p>
<div>
    <img src="assets/main.PNG", style="max-width:150%;margin-left: 50%;transform: translateX(-50%);">
</div>
<h3 id="analyse-de-la-fonction-main">Analyse de la fonction main</h3>
<p>La fonction va v√©rifier qu&rsquo;un argument a √©t√© fourni au programme (un nom de fichier est attendu) et si c&rsquo;est le cas il en lit le contenu et le copie dans un chunk de m√©moire r√©cemment allou√©. Puis il alloue une nouvelle zone de m√©moire de taille <code>&lt;taille du fichier&gt; + 0x10000</code>. Il copie ensuite le contenu du fichier √† l&rsquo;adresse <code>&lt;chunk allou√©&gt; + 0x10000</code>. De plus on peut voir ceci:</p>
<div>
    <img src="assets/PC_SP.PNG", style="max-width:150%;margin-left: 50%;transform: translateX(-50%);">
</div>
<p>Si l&rsquo;on part du principe que le binaire stocke les registres de la machine virtuelle dans sa <code>.bss</code>, on peut conjecturer que ces deux variables dans la .bss sont en faites le <code>Program Counter</code> et le <code>Stack Pointer</code> de la VM. Le programme en m√©moire aurait donc cette forme:</p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 488 361"
      >
      <g transform='translate(8,16)'>
<path d='M 136,48 L 328,48' fill='none' stroke='currentColor'></path>
<path d='M 136,192 L 328,192' fill='none' stroke='currentColor'></path>
<path d='M 136,336 L 328,336' fill='none' stroke='currentColor'></path>
<path d='M 120,64 L 120,192' fill='none' stroke='currentColor'></path>
<path d='M 120,208 L 120,336' fill='none' stroke='currentColor'></path>
<path d='M 136,48 L 136,192' fill='none' stroke='currentColor'></path>
<path d='M 136,192 L 136,336' fill='none' stroke='currentColor'></path>
<path d='M 328,48 L 328,192' fill='none' stroke='currentColor'></path>
<path d='M 328,192 L 328,336' fill='none' stroke='currentColor'></path>
<polygon points='128.000000,64.000000 116.000000,58.400002 116.000000,69.599998' fill='currentColor' transform='rotate(270.000000, 120.000000, 64.000000)'></polygon>
<polygon points='128.000000,192.000000 116.000000,186.399994 116.000000,197.600006' fill='currentColor' transform='rotate(90.000000, 120.000000, 192.000000)'></polygon>
<polygon points='128.000000,208.000000 116.000000,202.399994 116.000000,213.600006' fill='currentColor' transform='rotate(270.000000, 120.000000, 208.000000)'></polygon>
<polygon points='128.000000,336.000000 116.000000,330.399994 116.000000,341.600006' fill='currentColor' transform='rotate(90.000000, 120.000000, 336.000000)'></polygon>
<text text-anchor='middle' x='24' y='196' fill='currentColor' style='font-size:1em'>+</text>
<text text-anchor='middle' x='32' y='52' fill='currentColor' style='font-size:1em'>B</text>
<text text-anchor='middle' x='32' y='196' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='40' y='52' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='40' y='196' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='48' y='52' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='48' y='196' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='56' y='52' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='56' y='196' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='64' y='196' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='72' y='52' fill='currentColor' style='font-size:1em'>A</text>
<text text-anchor='middle' x='72' y='196' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='80' y='52' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='80' y='196' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='88' y='52' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='96' y='52' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='104' y='52' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='112' y='52' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='120' y='52' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='128' y='20' fill='currentColor' style='font-size:1em'>L</text>
<text text-anchor='middle' x='136' y='20' fill='currentColor' style='font-size:1em'>'</text>
<text text-anchor='middle' x='144' y='20' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='152' y='20' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='160' y='20' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='168' y='20' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='176' y='20' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='184' y='20' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='192' y='20' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='200' y='20' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='208' y='20' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='216' y='116' fill='currentColor' style='font-size:1em'>S</text>
<text text-anchor='middle' x='216' y='260' fill='currentColor' style='font-size:1em'>C</text>
<text text-anchor='middle' x='224' y='20' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='224' y='116' fill='currentColor' style='font-size:1em'>T</text>
<text text-anchor='middle' x='224' y='260' fill='currentColor' style='font-size:1em'>O</text>
<text text-anchor='middle' x='232' y='20' fill='currentColor' style='font-size:1em'>√©</text>
<text text-anchor='middle' x='232' y='116' fill='currentColor' style='font-size:1em'>A</text>
<text text-anchor='middle' x='232' y='260' fill='currentColor' style='font-size:1em'>D</text>
<text text-anchor='middle' x='240' y='20' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='240' y='116' fill='currentColor' style='font-size:1em'>C</text>
<text text-anchor='middle' x='240' y='260' fill='currentColor' style='font-size:1em'>E</text>
<text text-anchor='middle' x='248' y='20' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='248' y='116' fill='currentColor' style='font-size:1em'>K</text>
<text text-anchor='middle' x='256' y='20' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='264' y='20' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='272' y='20' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='288' y='20' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='296' y='20' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='312' y='20' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='320' y='20' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='336' y='20' fill='currentColor' style='font-size:1em'>V</text>
<text text-anchor='middle' x='344' y='20' fill='currentColor' style='font-size:1em'>M</text>
<text text-anchor='middle' x='344' y='52' fill='currentColor' style='font-size:1em'>(</text>
<text text-anchor='middle' x='352' y='52' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='360' y='52' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='368' y='52' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='376' y='52' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='384' y='52' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='392' y='52' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='400' y='52' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='416' y='52' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='424' y='52' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='440' y='52' fill='currentColor' style='font-size:1em'>h</text>
<text text-anchor='middle' x='448' y='52' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='456' y='52' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='464' y='52' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='472' y='52' fill='currentColor' style='font-size:1em'>)</text>
</g>

    </svg>
  
</div>
<p>On renomme en vitesse les variables:</p>
<div>
    <img src="assets/main_memory.PNG", style="max-width:150%;margin-left: 50%;transform: translateX(-50%);">
</div>
<p>On remarque que l&rsquo;adresse de la m√©moire de la VM (<code>memory</code>) et la taille de la m√©moire (<code>memory_range</code>) sont stock√©es dans la <code>.bss</code>.</p>
<p>Ensuite la fontion main va appeller une fonction que l&rsquo;on nommera <code>vm_start</code>.</p>
<h3 id="analyse-de-la-fonction-vm_start">Analyse de la fonction vm_start</h3>
<p>Cette fonction s&rsquo;apparente √† une boucle qui va parcourir le code de notre programme.</p>
<div>
    <img src="assets/VM_loop.PNG", style="max-width:150%;margin-left: 50%;transform: translateX(-50%);">
</div>
<p>On y voit l&rsquo;appel √† trois fonctions:</p>
<ul>
<li><strong>sub_2061</strong> que l&rsquo;on va renommer <code>handler_exit</code> et va faire quitter la VM puis lib√©rer sa m√©moire.</li>
<li><strong>sub_1440</strong> que l&rsquo;on va renommer <code>vm_run</code> et qui va se charger d&rsquo;ex√©cuter chaque instruction (on y reviendra).</li>
<li><strong>sub_208c</strong> qui prend en param√®tre &ldquo;main&rdquo; et que l&rsquo;on va analyser maintenant!</li>
</ul>
<h3 id="analyse-de-la-fonction-find_symbol">Analyse de la fonction find_symbol</h3>
<p>L&rsquo;objectif de cette fonction va √™tre de trouver un symbole dans le code de la VM, elle est appell√© au d√©but de l&rsquo;ex√©cution du code pour trouver la fonction <code>main</code>. Renommons les principales variables:</p>
<div>
    <img src="assets/find_symbol.PNG", style="max-width:150%;margin-left: 50%;transform: translateX(-50%);">
</div>
<p>La fonction va it√©rer parmis le code jusqu&rsquo;√† trouver un certain motif qui indique le d√©but du code associ√© au symbole. Par exemple pour trouver une fonction nomm√©e <code>func</code>, le programme va chercher ce motif dans le programme de la VM:</p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 400 121"
      >
      <g transform='translate(8,16)'>
<path d='M 0,0 L 56,0' fill='none' stroke='currentColor'></path>
<path d='M 56,0 L 168,0' fill='none' stroke='currentColor'></path>
<path d='M 168,0 L 240,0' fill='none' stroke='currentColor'></path>
<path d='M 240,0 L 296,0' fill='none' stroke='currentColor'></path>
<path d='M 0,32 L 56,32' fill='none' stroke='currentColor'></path>
<path d='M 56,32 L 168,32' fill='none' stroke='currentColor'></path>
<path d='M 168,32 L 240,32' fill='none' stroke='currentColor'></path>
<path d='M 240,32 L 296,32' fill='none' stroke='currentColor'></path>
<path d='M 0,0 L 0,32' fill='none' stroke='currentColor'></path>
<path d='M 56,0 L 56,32' fill='none' stroke='currentColor'></path>
<path d='M 168,0 L 168,32' fill='none' stroke='currentColor'></path>
<path d='M 240,0 L 240,32' fill='none' stroke='currentColor'></path>
<path d='M 296,0 L 296,32' fill='none' stroke='currentColor'></path>
<path d='M 304,48 L 304,64' fill='none' stroke='currentColor'></path>
<polygon points='312.000000,48.000000 300.000000,42.400002 300.000000,53.599998' fill='currentColor' transform='rotate(270.000000, 304.000000, 48.000000)'></polygon>
<text text-anchor='middle' x='16' y='20' fill='currentColor' style='font-size:1em'>\</text>
<text text-anchor='middle' x='24' y='20' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='32' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='40' y='20' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='72' y='20' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='80' y='20' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='88' y='20' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='96' y='20' fill='currentColor' style='font-size:1em'>(</text>
<text text-anchor='middle' x='104' y='20' fill='currentColor' style='font-size:1em'>"</text>
<text text-anchor='middle' x='112' y='20' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='120' y='20' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='128' y='20' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='136' y='20' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='144' y='20' fill='currentColor' style='font-size:1em'>"</text>
<text text-anchor='middle' x='152' y='20' fill='currentColor' style='font-size:1em'>)</text>
<text text-anchor='middle' x='184' y='20' fill='currentColor' style='font-size:1em'>"</text>
<text text-anchor='middle' x='192' y='20' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='200' y='20' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='208' y='20' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='216' y='20' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='224' y='20' fill='currentColor' style='font-size:1em'>"</text>
<text text-anchor='middle' x='256' y='20' fill='currentColor' style='font-size:1em'>\</text>
<text text-anchor='middle' x='264' y='20' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='264' y='84' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='264' y='100' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='272' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='272' y='84' fill='currentColor' style='font-size:1em'>√©</text>
<text text-anchor='middle' x='272' y='100' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='280' y='20' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='280' y='84' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='288' y='84' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='288' y='100' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='296' y='84' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='296' y='100' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='304' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='312' y='84' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='312' y='100' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='320' y='84' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='320' y='100' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='328' y='100' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='336' y='84' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='336' y='100' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='344' y='84' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='344' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='352' y='84' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='360' y='84' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='360' y='100' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='368' y='100' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='376' y='84' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='376' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='384' y='84' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='384' y='100' fill='currentColor' style='font-size:1em'>c</text>
</g>

    </svg>
  
</div>
<p>Une fois ce motif trouv√©, la valeur de <code>PC</code> va √™tre mise √† jour avec l&rsquo;offset du code suivant ce motif, voil√† comment la VM va faire en sorte de g√©rer les proc√©dures d&rsquo;appel. Le premier appel √† cette fonction est fonc fait dans l&rsquo;objectif de trouver la fonction main qui se trouve logiquement au tout d√©but du code propos√© par le challenge:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">00000000: <span class="m">0104</span> 6d61 696e 027c <span class="m">1700</span> <span class="m">0000</span> 506c <span class="m">6561</span>  ..main.<span class="p">|</span>....Plea
</span></span><span class="line"><span class="cl">00000010: <span class="m">7365</span> <span class="m">2065</span> 6e74 <span class="m">6572</span> <span class="m">2074</span> <span class="m">6865</span> 206b <span class="m">6579</span>  se enter the key
</span></span></code></pre></div><p>On remarque aussi plusieurs appels √† une fonction que j&rsquo;ai nomm√© <code>vm_error</code> et qui prend en premier argument, un code associ√© √† une erreur possible, comme par exemple si le program counter d√©passe la limite de la m√©moire allou√©e au code:</p>
<div>
    <img src="assets/vm_error.PNG", style="max-width:130%;margin-left: 50%;transform: translateX(-50%);">
</div>
<p>Maintenant on va passer √† la fonction principale, cell qui va fetch chaque opcode et ex√©cuter les diff√©rentes instructions associ√©es.</p>
<h3 id="analyse-du-dispacher-de-la-vm">Analyse du dispacher de la VM</h3>
<p>En regardant le graphe du dispacher, ce dernier s&rsquo;apparente au graphe d&rsquo;un switch case classique, ou chaque handler va repr√©senter une instruction g√©r√©e par l&rsquo;architecture de la VM.</p>
<div>
    <img src="assets/dispacher_graph.PNG", style="max-width:150%;margin-left: 50%;transform: translateX(-50%);">
</div>
<p>Il y&rsquo;a 17 handlers, donc chaque opcode tient sur 1 octet, les bytes suivants l&rsquo;opcodes caract√©risent les op√©randes de l&rsquo;instruction. Voil√† les diff√©rentes instructions faisables par le processeur virtuel:</p>
<ul>
<li><strong>NOP</strong></li>
<li><strong>JZ</strong>: Saut conditionnel en fonction de si un registre, que l&rsquo;on nommera <code>A</code>, est nul ou non.</li>
<li><strong>MOV CST</strong>: Met la constante pass√©e en op√©rande dans le registre pass√© en op√©rande.</li>
<li><strong>PRINT</strong>: Affiche la chaine de caract√®re point√©e par le registre A.</li>
<li><strong>READ</strong>: Lit une chaine depuis <code>stdin</code> vers la stack.</li>
<li><strong>AND</strong></li>
<li><strong>CALL</strong>: Effectue une proc√©dure d&rsquo;appel vers une fonction trouv√©e dans le code via un appel √† <code>find_symbol</code>.</li>
<li><strong>RET</strong></li>
<li><strong>ADD</strong></li>
<li><strong>EXIT</strong>: Fait un appel √† <code>handler_exit</code> dont nous avons d√©j√† parl√©.</li>
<li><strong>READ_FROM_FILE</strong>: Lit le contenu d&rsquo;un fichier dont la taille est contenue dans <code>B</code> et le nom dans <code>A</code>.</li>
<li><strong>MOV</strong>: Op√©rande mov classique entre deux registres virtuels.</li>
<li><strong>POP</strong></li>
<li><strong>PUSH</strong></li>
<li><strong>XOR</strong></li>
<li><strong>JMP</strong></li>
</ul>
<p>Pour pouvoir mettre en place l&rsquo;instrumentation du binaire, il va nous falloir comprendre comment chaque handler va acc√©der au registres et √† la pile de la VM.
Penchons nous par exemple sur le handler qui va g√©rer l&rsquo;instruction <code>ADD</code>:</p>
<div>
    <img src="assets/handler_add.PNG", style="max-width:150%;margin-left: 50%;transform: translateX(-50%);">
</div>
<p>L&rsquo;addition en question a l&rsquo;air de se faire √† l&rsquo;adresse <code>0x172a</code>, et on voit deux appels √† une fonction <code>sub_2303</code>. Cette derni√®re, au moyen d&rsquo;un autre switch case en fonction de son premier argument va renvoyer un pointeur vers une variable de 32 bits dans la .bss. Et vous le voyez venir ces variables sont nos registres virtuels. Le premier argument pass√© en param√®tre √† cette fonction √©tant une constante associ√©e √† un registre, apr√®s avoir fouill√© dans les autres handlers, on peut renommer les registres restants et noter leurs adresses, elles nous seront utiles:</p>
<div>
    <img src="assets/registers.PNG", style="max-width:150%;margin-left: 50%;transform: translateX(-50%);">
</div>
<p>Et √ßa c&rsquo;est tr√®s int√©ressant, on a trouv√© une fonction qui va √™tre appel√© √† chaque fois qu&rsquo;un registre virtuel est acc√©d√©, que ce soit pour y √©crire ou y lire. Renommons cette fonction en <code>access_register_bank</code>. Et en fouillant un peu plus dans les autres handlers, dans le handler associ√© √† <code>MOV CST</code>, on remarque ceci:</p>
<div>
    <img src="assets/access_memory.PNG", style="max-width:150%;margin-left: 50%;transform: translateX(-50%);">
</div>
<p>La fonction sous le nom <code>access_memory</code> va juste se charger de d√©r√©f√©rencer la variable 32 bit point√©e par son argument. En l&rsquo;occurence elle est appell√© pour acc√©der √† la variable point√©e par: <code>&lt;memory&gt; + &lt;seconde operande&gt;</code>. Et comme on le remarque dans les <code>xrefs</code> de la fonction, cette derni√®re est appell√©e √† chaque fois que le programme a besoin de r√©cup√©rer une op√©rande ne faisant pas partie des registres dans son code</p>
<div>
    <img src="assets/xref.PNG", style="max-width:150%;margin-left: 50%;transform: translateX(-50%);">
</div>
<p>Et c&rsquo;est gr√¢ce √† l&rsquo;usage de ces fonctions qu&rsquo;on va pouvoir obtenir une trace d&rsquo;ex√©cution de notre VM:</p>
<ul>
<li>On peut hook chaque acc√®s aux registres virtuels gr√¢ce √† la fonction <code>access_register_bank</code>.</li>
<li>On peut hook chaque acc√®s √† la m√©moire du code avec la fonction <code>access_memory</code>.</li>
<li>On peut hook chaque appel √† une fonction gr√¢ce √† <code>find_symbol</code>.</li>
</ul>
<p>Voil√† comment on va s&rsquo;y prendre globalement:
On enregistre chaque acc√®s aux registres et √† la m√©moire, ensuite on va hook chaque handler et voir quels op√©randes viennent de lui √™tre pass√©es. On va aussi mettre en place une option <code>DEBUG</code> qui, en utilisant la m√©thode <code>ql.mem.read</code>, va nous permettre d&rsquo;avoir pour chaque registre et chaque case m√©moire sa valeur pr√©cise √† chaque instruction!</p>
<h2 id="tracing-de-la-vm-avec-qiling">Tracing de la VM avec Qiling</h2>
<p>Commen√ßons par lister touts les registres ainsi que les instructions possibles avec leurs types d&rsquo;op√©randes respectifs:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">BASE</span> <span class="o">=</span> <span class="mh">0x555555554000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">REGS_SYMBOLS</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x50f0</span><span class="p">:</span> <span class="s2">&#34;A&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x50f4</span><span class="p">:</span> <span class="s2">&#34;B&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x50f8</span><span class="p">:</span> <span class="s2">&#34;R0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x50fc</span><span class="p">:</span> <span class="s2">&#34;R1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x5100</span><span class="p">:</span> <span class="s2">&#34;R2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x5104</span><span class="p">:</span> <span class="s2">&#34;R3&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x5108</span><span class="p">:</span> <span class="s2">&#34;PC&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x50a8</span><span class="p">:</span> <span class="s2">&#34;SP&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HANDLERS</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x15ee</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&#34;jz&#34;</span><span class="p">,</span> <span class="s2">&#34;adr&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1705</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&#34;add&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x17e5</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&#34;sub&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x18c5</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&#34;and&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x19a5</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&#34;xor&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x209f</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&#34;call&#34;</span><span class="p">,</span> <span class="s2">&#34;func&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x14f6</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&#34;ret&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1bcf</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&#34;mov&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span> <span class="p">,</span><span class="s2">&#34;adr&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1ca3</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&#34;mov&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1d20</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&#34;jmp&#34;</span><span class="p">,</span> <span class="s2">&#34;adr&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1df8</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&#34;push&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1e86</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&#34;pop&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1544</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&#34;print&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1550</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&#34;read&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x155c</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&#34;readfile&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1563</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&#34;exit&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Super nickel üë®‚Äçüç≥! Maintenant on cr√©e des listes pour log chaque acc√®s aux registres:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">STACK</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">LAST_ACCESS_REGS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">LAST_ACCESS_MEM</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Cette adresse correspond √† l&#39;instruction `ret` de la fonction `access_register_bank`</span>
</span></span><span class="line"><span class="cl"><span class="c1"># En r√©cup√©rant la valeur de RAX on peut avoir l&#39;adresse du registre qui vient d&#39;√™tre acc√©d√©!</span>
</span></span><span class="line"><span class="cl"><span class="n">register_bank_access_ret</span> <span class="o">=</span> <span class="mh">0x2383</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hook_register_access</span><span class="p">(</span><span class="n">ql</span><span class="p">:</span> <span class="n">Qiling</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">reg</span> <span class="o">=</span> <span class="n">ql</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&#34;RAX&#34;</span><span class="p">)</span> <span class="o">-</span> <span class="n">BASE</span>
</span></span><span class="line"><span class="cl">    <span class="n">LAST_ACCESS_REGS</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ql</span><span class="o">.</span><span class="n">hook_address</span><span class="p">(</span><span class="n">hook_register_access</span><span class="p">,</span> <span class="n">register_bank_access_ret</span> <span class="o">+</span> <span class="n">BASE</span><span class="p">)</span>
</span></span></code></pre></div><p>On fait de m√™me avec les op√©randes m√©moires et les appels de fonction:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Ces adresses correspondent respectivement √† l&#39;instruction `ret` de la fonction `access_memory` pour r√©cup√©rer l&#39;op√©rande utilis√©e par l&#39;instruction suivante</span>
</span></span><span class="line"><span class="cl"><span class="c1"># et au prologue de la fonction `find_symbol` pour voir quelle fonction va √™tre appell√©e (le nom de la fonction se trouvera logiquement dans RDI)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">memory_access_ret</span> <span class="o">=</span> <span class="mh">0x239b</span>
</span></span><span class="line"><span class="cl"><span class="n">func_finder_prolog</span> <span class="o">=</span> <span class="mh">0x208c</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hook_memory_access</span><span class="p">(</span><span class="n">ql</span><span class="p">:</span> <span class="n">Qiling</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">mem</span> <span class="o">=</span> <span class="n">ql</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&#34;RDI&#34;</span><span class="p">)</span> <span class="o">-</span> <span class="n">BASE</span>
</span></span><span class="line"><span class="cl">    <span class="n">LAST_ACCESS_MEM</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hook_stackframes</span><span class="p">(</span><span class="n">ql</span><span class="p">:</span> <span class="n">Qiling</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">func_name</span> <span class="o">=</span> <span class="n">ql</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="n">ql</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&#34;RDI&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">STACK</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ql</span><span class="o">.</span><span class="n">hook_address</span><span class="p">(</span><span class="n">hook_memory_access</span><span class="p">,</span> <span class="n">memory_access_ret</span> <span class="o">+</span> <span class="n">BASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ql</span><span class="o">.</span><span class="n">hook_address</span><span class="p">(</span><span class="n">hook_stackframes</span><span class="p">,</span> <span class="n">func_finder_prolog</span> <span class="o">+</span> <span class="n">BASE</span><span class="p">)</span>
</span></span></code></pre></div><p>Et finalement on va hook au milieu de chaque handler pour afficher l&rsquo;instruction qui est en train d&rsquo;√™tre ex√©cut√©, pour savoir quelles op√©randes elle utilise, il suffir d&rsquo;aller voir dans les listes de logging qu&rsquo;on a cr√©√©:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hook_handlers</span><span class="p">(</span><span class="n">ql</span><span class="p">:</span> <span class="n">Qiling</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">rip</span> <span class="o">=</span> <span class="n">ql</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">rip</span> <span class="o">-</span> <span class="n">BASE</span>
</span></span><span class="line"><span class="cl">    <span class="n">handler</span> <span class="o">=</span> <span class="n">HANDLERS</span><span class="p">[</span><span class="n">rip</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># On it√®re parmis tous les param√®tres possibles</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Si pas plus de param√®tres</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">handler</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">handler</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;adr&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Si l&#39;op√©rande est un pointeur vers une constante</span>
</span></span><span class="line"><span class="cl">            <span class="n">ptr</span> <span class="o">=</span> <span class="n">LAST_ACCESS_MEM</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span><span class="si">}</span><span class="s2">]&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">handler</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reg&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Si l&#39;op√©rande est un registre</span>
</span></span><span class="line"><span class="cl">            <span class="n">ptr</span> <span class="o">=</span> <span class="n">LAST_ACCESS_REGS</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span> <span class="o">=</span> <span class="n">REGS_SYMBOLS</span><span class="p">[</span><span class="n">ptr</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">handler</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;func&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Si l&#39;op√©rande est le nom d&#39;une fonction (ptr c&#39;est pour l&#39;adresse PC)</span>
</span></span><span class="line"><span class="cl">            <span class="n">ptr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REGS_SYMBOLS</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="nb">list</span><span class="p">(</span><span class="n">REGS_SYMBOLS</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&#34;PC&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span> <span class="o">=</span> <span class="n">STACK</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&#34; -&gt; </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">ql</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">BASE</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ql</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;(</span><span class="si">{</span><span class="n">handler</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="s1">&#39; , &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">HANDLERS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">ql</span><span class="o">.</span><span class="n">hook_address</span><span class="p">(</span><span class="n">hook_handlers</span><span class="p">,</span> <span class="n">BASE</span> <span class="o">+</span> <span class="n">handler</span><span class="p">)</span>
</span></span></code></pre></div><p>Et une fois lanc√© avec l&rsquo;option <code>DEBUG</code> activ√©e et en rentrant en input <code>ABCDEFGH</code> on obtient le bytecode ex√©cut√© par la VM:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">[</span>VM started<span class="o">]=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>call<span class="o">)</span> main -&gt; 0x10000
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jmp<span class="o">)</span> <span class="o">[</span>0x195d8<span class="o">]</span> -&gt; 0x17
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> A -&gt; 0x0 , SP -&gt; 0xffe9
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	newfstatat<span class="o">(</span><span class="nv">dirfd</span> <span class="o">=</span> 0x1, <span class="nv">path</span> <span class="o">=</span> 0x7fffb7fc346f, <span class="nv">buf_ptr</span> <span class="o">=</span> 0x80000000dae0, <span class="nv">flags</span> <span class="o">=</span> 0x1000<span class="o">)</span> <span class="o">=</span> -0x1 <span class="o">(</span>EPERM<span class="o">)</span>
</span></span><span class="line"><span class="cl">Please enter the key: <span class="o">[=]</span> 	write<span class="o">(</span><span class="nv">fd</span> <span class="o">=</span> 0x1, <span class="nv">buf</span> <span class="o">=</span> 0x55555556d710, <span class="nv">count</span> <span class="o">=</span> 0x16<span class="o">)</span> <span class="o">=</span> 0x16
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>print<span class="o">)</span> 
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> B -&gt; 0x0 , <span class="o">[</span>0x195f9<span class="o">]</span> -&gt; 0x100
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	newfstatat<span class="o">(</span><span class="nv">dirfd</span> <span class="o">=</span> 0x0, <span class="nv">path</span> <span class="o">=</span> 0x7fffb7fc346f, <span class="nv">buf_ptr</span> <span class="o">=</span> 0x80000000dab0, <span class="nv">flags</span> <span class="o">=</span> 0x1000<span class="o">)</span> <span class="o">=</span> -0x1 <span class="o">(</span>EPERM<span class="o">)</span>
</span></span><span class="line"><span class="cl">ABCDEFGH
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	read<span class="o">(</span><span class="nv">fd</span> <span class="o">=</span> 0x0, <span class="nv">buf</span> <span class="o">=</span> 0x55555556f720, <span class="nv">length</span> <span class="o">=</span> 0x2000<span class="o">)</span> <span class="o">=</span> 0x9
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span><span class="nb">read</span><span class="o">)</span> 
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R1 -&gt; 0x0 , SP -&gt; 0xfee9
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jmp<span class="o">)</span> <span class="o">[</span>0x19602<span class="o">]</span> -&gt; 0xb0
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>xor<span class="o">)</span> R2 -&gt; 0x0 , R2 -&gt; 0x0
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> A -&gt; 0xffe9 , <span class="o">[</span>0x196bb<span class="o">]</span> -&gt; 0x2c
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> B -&gt; 0x100 , SP -&gt; 0xfe39
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> SP -&gt; 0xfe39 , R1 -&gt; 0xfee9
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfee9 , R2 -&gt; 0x0
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> R0 -&gt; 0x0
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> SP -&gt; 0xfeed , B -&gt; 0xfe39
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> B -&gt; 0xfe39
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>xor<span class="o">)</span> B -&gt; 0x11213d63 , R0 -&gt; 0x44434241
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>push<span class="o">)</span> B -&gt; 0x55627f22
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R3 -&gt; 0x0 , <span class="o">[</span>0x196d6<span class="o">]</span> -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfe39 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> R2 -&gt; 0x0 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>and<span class="o">)</span> R2 -&gt; 0x4 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R3 -&gt; 0x4 , <span class="o">[</span>0x196e5<span class="o">]</span> -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>sub<span class="o">)</span> A -&gt; 0x2c , R3 -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jz<span class="o">)</span> <span class="o">[</span>0x196ed<span class="o">]</span> -&gt; 0xffffffd2
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> B -&gt; 0x55627f22 , SP -&gt; 0xfe3d
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> SP -&gt; 0xfe3d , R1 -&gt; 0xfee9
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfee9 , R2 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> R0 -&gt; 0x44434241
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> SP -&gt; 0xfef1 , B -&gt; 0xfe3d
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> B -&gt; 0xfe3d
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>xor<span class="o">)</span> B -&gt; 0x33195222 , R0 -&gt; 0x48474645
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>push<span class="o">)</span> B -&gt; 0x7b5e1467
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R3 -&gt; 0x1 , <span class="o">[</span>0x196d6<span class="o">]</span> -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfe3d , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> R2 -&gt; 0x4 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>and<span class="o">)</span> R2 -&gt; 0x8 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R3 -&gt; 0x4 , <span class="o">[</span>0x196e5<span class="o">]</span> -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>sub<span class="o">)</span> A -&gt; 0x2b , R3 -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jz<span class="o">)</span> <span class="o">[</span>0x196ed<span class="o">]</span> -&gt; 0xffffffd2
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> B -&gt; 0x7b5e1467 , SP -&gt; 0xfe41
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> SP -&gt; 0xfe41 , R1 -&gt; 0xfee9
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfee9 , R2 -&gt; 0x0
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> R0 -&gt; 0x48474645
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> SP -&gt; 0xfeed , B -&gt; 0xfe41
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> B -&gt; 0xfe41
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>xor<span class="o">)</span> B -&gt; 0x7b3b5109 , R0 -&gt; 0x44434241
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>push<span class="o">)</span> B -&gt; 0x3f781348
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R3 -&gt; 0x1 , <span class="o">[</span>0x196d6<span class="o">]</span> -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfe41 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> R2 -&gt; 0x0 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>and<span class="o">)</span> R2 -&gt; 0x4 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R3 -&gt; 0x4 , <span class="o">[</span>0x196e5<span class="o">]</span> -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>sub<span class="o">)</span> A -&gt; 0x2a , R3 -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jz<span class="o">)</span> <span class="o">[</span>0x196ed<span class="o">]</span> -&gt; 0xffffffd2
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> B -&gt; 0x3f781348 , SP -&gt; 0xfe45
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> SP -&gt; 0xfe45 , R1 -&gt; 0xfee9
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfee9 , R2 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> R0 -&gt; 0x44434241
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> SP -&gt; 0xfef1 , B -&gt; 0xfe45
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> B -&gt; 0xfe45
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>xor<span class="o">)</span> B -&gt; 0x6c722b3b , R0 -&gt; 0x48474645
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>push<span class="o">)</span> B -&gt; 0x24356d7e
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R3 -&gt; 0x1 , <span class="o">[</span>0x196d6<span class="o">]</span> -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfe45 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> R2 -&gt; 0x4 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>and<span class="o">)</span> R2 -&gt; 0x8 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R3 -&gt; 0x4 , <span class="o">[</span>0x196e5<span class="o">]</span> -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>sub<span class="o">)</span> A -&gt; 0x29 , R3 -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jz<span class="o">)</span> <span class="o">[</span>0x196ed<span class="o">]</span> -&gt; 0xffffffd2
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> B -&gt; 0x7a112443 , SP -&gt; 0xfee1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> SP -&gt; 0xfee1 , R1 -&gt; 0xfee9
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfee9 , R2 -&gt; 0x0
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> R0 -&gt; 0x48474645
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> SP -&gt; 0xfeed , B -&gt; 0xfee1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> B -&gt; 0xfee1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>xor<span class="o">)</span> B -&gt; 0x596c7523 , R0 -&gt; 0x44434241
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>push<span class="o">)</span> B -&gt; 0x1d2f3762
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R3 -&gt; 0x1 , <span class="o">[</span>0x196d6<span class="o">]</span> -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfee1 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> R2 -&gt; 0x0 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>and<span class="o">)</span> R2 -&gt; 0x4 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R3 -&gt; 0x4 , <span class="o">[</span>0x196e5<span class="o">]</span> -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>sub<span class="o">)</span> A -&gt; 0x2 , R3 -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jz<span class="o">)</span> <span class="o">[</span>0x196ed<span class="o">]</span> -&gt; 0xffffffd2
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> B -&gt; 0x1d2f3762 , SP -&gt; 0xfee5
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> SP -&gt; 0xfee5 , R1 -&gt; 0xfee9
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfee9 , R2 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> R0 -&gt; 0x44434241
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> SP -&gt; 0xfef1 , B -&gt; 0xfee5
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> B -&gt; 0xfee5
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>xor<span class="o">)</span> B -&gt; 0x2b336614 , R0 -&gt; 0x48474645
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>push<span class="o">)</span> B -&gt; 0x63742051
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R3 -&gt; 0x1 , <span class="o">[</span>0x196d6<span class="o">]</span> -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfee5 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> R2 -&gt; 0x4 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>and<span class="o">)</span> R2 -&gt; 0x8 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R3 -&gt; 0x4 , <span class="o">[</span>0x196e5<span class="o">]</span> -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>sub<span class="o">)</span> A -&gt; 0x1 , R3 -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jz<span class="o">)</span> <span class="o">[</span>0x196ed<span class="o">]</span> -&gt; 0xffffffd2
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R3 -&gt; 0x1 , <span class="o">[</span>0x196f3<span class="o">]</span> -&gt; 0x100
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>sub<span class="o">)</span> SP -&gt; 0xfee9 , R3 -&gt; 0x100
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>call<span class="o">)</span> check_key -&gt; 0x10135
</span></span><span class="line"><span class="cl">Error: <span class="o">[=]</span> 	write<span class="o">(</span><span class="nv">fd</span> <span class="o">=</span> 0x2, <span class="nv">buf</span> <span class="o">=</span> 0x5555555571e8, <span class="nv">count</span> <span class="o">=</span> 0x7<span class="o">)</span> <span class="o">=</span> 0x7
</span></span><span class="line"><span class="cl">Function <span class="s2">&#34;check_key&#34;</span> not found<span class="o">[=]</span> 	write<span class="o">(</span><span class="nv">fd</span> <span class="o">=</span> 0x2, <span class="nv">buf</span> <span class="o">=</span> 0x80000000ba10, <span class="nv">count</span> <span class="o">=</span> 0x1e<span class="o">)</span> <span class="o">=</span> 0x1e
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	write<span class="o">(</span><span class="nv">fd</span> <span class="o">=</span> 0x2, <span class="nv">buf</span> <span class="o">=</span> 0x7fffb8005723, <span class="nv">count</span> <span class="o">=</span> 0x1<span class="o">)</span> <span class="o">=</span> 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	exit_group<span class="o">(</span><span class="nv">code</span> <span class="o">=</span> 0x3<span class="o">)</span> <span class="o">=</span> ?
</span></span></code></pre></div><p>Ok donc l√† on a plein de choses int√©ressantes, d√©j√† on voit l&rsquo;appel √† la fonction <code>main</code>, puis un ensemble d&rsquo;instructions qui se r√©p√®te:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> B -&gt; 0x100 , SP -&gt; 0xfe39
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> SP -&gt; 0xfe39 , R1 -&gt; 0xfee9
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfee9 , R2 -&gt; 0x0
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> R0 -&gt; 0x0
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> SP -&gt; 0xfeed , B -&gt; 0xfe39
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> B -&gt; 0xfe39
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>xor<span class="o">)</span> B -&gt; 0x11213d63 , R0 -&gt; 0x44434241
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>push<span class="o">)</span> B -&gt; 0x55627f22
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R3 -&gt; 0x0 , <span class="o">[</span>0x196d6<span class="o">]</span> -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfe39 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> R2 -&gt; 0x0 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>and<span class="o">)</span> R2 -&gt; 0x4 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R3 -&gt; 0x4 , <span class="o">[</span>0x196e5<span class="o">]</span> -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>sub<span class="o">)</span> A -&gt; 0x2c , R3 -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jz<span class="o">)</span> <span class="o">[</span>0x196ed<span class="o">]</span> -&gt; 0xffffffd2
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> B -&gt; 0x55627f22 , SP -&gt; 0xfe3d
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> SP -&gt; 0xfe3d , R1 -&gt; 0xfee9
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfee9 , R2 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> R0 -&gt; 0x44434241
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> SP -&gt; 0xfef1 , B -&gt; 0xfe3d
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> B -&gt; 0xfe3d
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>xor<span class="o">)</span> B -&gt; 0x33195222 , R0 -&gt; 0x48474645
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>push<span class="o">)</span> B -&gt; 0x7b5e1467
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R3 -&gt; 0x1 , <span class="o">[</span>0x196d6<span class="o">]</span> -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfe3d , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> R2 -&gt; 0x4 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>and<span class="o">)</span> R2 -&gt; 0x8 , R3 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R3 -&gt; 0x4 , <span class="o">[</span>0x196e5<span class="o">]</span> -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>sub<span class="o">)</span> A -&gt; 0x2b , R3 -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jz<span class="o">)</span> <span class="o">[</span>0x196ed<span class="o">]</span> -&gt; 0xffffffd2
</span></span></code></pre></div><p>A chaque fois que ce code se r√©p√®te, la valeur contenue dans A est d√©cr√©ment√©e de 1, et ensuite on a un saut conditionnel vers <code>0x196ed</code>: On a affaire √† une boucle qui va visiblement XORer une zone de m√©moire avec notre input. Si vous vous souvenez au d√©but quand on avait lanc√© l&rsquo;ex√©cutable avec une cl√© al√©atoire on avait eu une erreur comme quoi la fonction <code>check_key</code> n&rsquo;a pas pu √™tre trouv√©, en fait il s&rsquo;agit de packing ,la VM va d√©chiffrer la suite de son code avec notre cl√© qui doit faire donc 8 caract√®res!</p>
<p>Mais comment sommes nous cens√©s trouver la cl√© pour acc√©der √† la suite du code si on n&rsquo;a aucune id√©e de ce dernier me direz vous?
Et bien on sait au moins que le programme va tenter, apr√®s le d√©chiffrement d&rsquo;appeller la fonction <code>check_key</code> et on sait √† quoi doit ressembler le motif qui indique la pr√©sence d&rsquo;une fonction √† un endroit pr√©cis dans le code üòÄ!</p>
<p>On est donc dans une situation triviale de XOR avec clair connu:
Les premiers octets √† d√©chiffrer sont <code>0x11213d63</code> et <code>0x33195222</code> et que leur version d√©chiffr√©e doit correspondre √† <code>b&quot;\x01\x09check_&quot;</code>. Donc:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">enc</span> <span class="o">=</span> <span class="mh">0x33195222</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="mh">0x11213d63</span>
</span></span><span class="line"><span class="cl"><span class="n">plain</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x01\x09</span><span class="s2">check_&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">enc</span> <span class="o">^</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">plain</span><span class="p">,</span> <span class="s2">&#34;little&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&#34;little&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># b4ByG1rl</span>
</span></span></code></pre></div><p>Nice! Maintenant on a la bonne cl√© de d√©chiffrement qui va unpack le code de la VM, testons de lancer le programme avec cette cl√©:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./vm reverse_my_vm.vmr 
</span></span><span class="line"><span class="cl">Please enter the key: b4ByG1rl
</span></span><span class="line"><span class="cl">Now, enter the passcode: TEST
</span></span><span class="line"><span class="cl">Congrats! Your flag is: A<span class="p">|</span>p7Ko<span class="o">[</span>JoW.x
</span></span><span class="line"><span class="cl">                                    HB
</span></span></code></pre></div><p>Ok donc le programme nous demande maintenant un mot de passe avec lequel il va visiblement faire des op√©rations qui devraient nous afficher un flag si le mot de passe est corret. Pour le d√©couvrir il nous suffit de relancer notre tracer:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Now, enter the passcode: 
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	write<span class="o">(</span><span class="nv">fd</span> <span class="o">=</span> 0x1, <span class="nv">buf</span> <span class="o">=</span> 0x55555556d710, <span class="nv">count</span> <span class="o">=</span> 0x19<span class="o">)</span> <span class="o">=</span> 0x19
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>print<span class="o">)</span> 
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> B -&gt; 0x47415753 , <span class="o">[</span>0x1943a<span class="o">]</span> -&gt; 0x100
</span></span><span class="line"><span class="cl">ABCD
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	read<span class="o">(</span><span class="nv">fd</span> <span class="o">=</span> 0x0, <span class="nv">buf</span> <span class="o">=</span> 0x55555556f720, <span class="nv">length</span> <span class="o">=</span> 0x2000<span class="o">)</span> <span class="o">=</span> 0x5
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span><span class="nb">read</span><span class="o">)</span> 
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> R3 -&gt; 0x100
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jmp<span class="o">)</span> <span class="o">[</span>0x19442<span class="o">]</span> -&gt; 0x2
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jmp<span class="o">)</span> <span class="o">[</span>0x19449<span class="o">]</span> -&gt; 0x18
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R2 -&gt; 0x0 , SP -&gt; 0xfcb5
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> A -&gt; 0xfdcb , <span class="o">[</span>0x1946a<span class="o">]</span> -&gt; 0x6
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> B -&gt; 0x100 , <span class="o">[</span>0x19470<span class="o">]</span> -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> R0 -&gt; 0x6c723147 , <span class="o">[</span>0x19476<span class="o">]</span> -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> R1 -&gt; 0xfee9
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>xor<span class="o">)</span> R1 -&gt; 0x28570444 , R3 -&gt; 0x44434241
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>push<span class="o">)</span> R1 -&gt; 0x6c144605
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfcb5 , R0 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>sub<span class="o">)</span> A -&gt; 0x6 , B -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jz<span class="o">)</span> <span class="o">[</span>0x19488<span class="o">]</span> -&gt; 0xfffffff2
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> R1 -&gt; 0x6c144605
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>xor<span class="o">)</span> R1 -&gt; 0x3b187224 , R3 -&gt; 0x44434241
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>push<span class="o">)</span> R1 -&gt; 0x7f5b3065
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfcb9 , R0 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>sub<span class="o">)</span> A -&gt; 0x5 , B -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jz<span class="o">)</span> <span class="o">[</span>0x19488<span class="o">]</span> -&gt; 0xfffffff2
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> R1 -&gt; 0x7f5b3065
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>xor<span class="o">)</span> R1 -&gt; 0x5a085744 , R3 -&gt; 0x44434241
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>push<span class="o">)</span> R1 -&gt; 0x1e4b1505
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfcbd , R0 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>sub<span class="o">)</span> A -&gt; 0x4 , B -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jz<span class="o">)</span> <span class="o">[</span>0x19488<span class="o">]</span> -&gt; 0xfffffff2
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> R1 -&gt; 0x1e4b1505
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>xor<span class="o">)</span> R1 -&gt; 0x5a3c531e , R3 -&gt; 0x44434241
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>push<span class="o">)</span> R1 -&gt; 0x1e7f115f
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfcc1 , R0 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>sub<span class="o">)</span> A -&gt; 0x3 , B -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jz<span class="o">)</span> <span class="o">[</span>0x19488<span class="o">]</span> -&gt; 0xfffffff2
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> R1 -&gt; 0x1e7f115f
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>xor<span class="o">)</span> R1 -&gt; 0x582b6b03 , R3 -&gt; 0x44434241
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>push<span class="o">)</span> R1 -&gt; 0x1c682942
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfcc5 , R0 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>sub<span class="o">)</span> A -&gt; 0x2 , B -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jz<span class="o">)</span> <span class="o">[</span>0x19488<span class="o">]</span> -&gt; 0xfffffff2
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>pop<span class="o">)</span> R1 -&gt; 0x1c682942
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>xor<span class="o">)</span> R1 -&gt; 0x1642581c , R3 -&gt; 0x44434241
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>push<span class="o">)</span> R1 -&gt; 0x52011a5d
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>add<span class="o">)</span> SP -&gt; 0xfcc9 , R0 -&gt; 0x4
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>sub<span class="o">)</span> A -&gt; 0x1 , B -&gt; 0x1
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jz<span class="o">)</span> <span class="o">[</span>0x19488<span class="o">]</span> -&gt; 0xfffffff2
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> SP -&gt; 0xfccd , R2 -&gt; 0xfcb5
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>jmp<span class="o">)</span> <span class="o">[</span>0x19490<span class="o">]</span> -&gt; 0x18
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>mov<span class="o">)</span> A -&gt; 0x0 , SP -&gt; 0xfc9d
</span></span><span class="line"><span class="cl">Congrats! Your flag is: Fle0<span class="o">[</span>K_B<span class="o">)</span>h<span class="o">]</span>√Ø¬ø¬ΩR
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	write<span class="o">(</span><span class="nv">fd</span> <span class="o">=</span> 0x1, <span class="nv">buf</span> <span class="o">=</span> 0x55555556d710, <span class="nv">count</span> <span class="o">=</span> 0x31<span class="o">)</span> <span class="o">=</span> 0x31
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>print<span class="o">)</span> 
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span>xor<span class="o">)</span> A -&gt; 0xfc9d , A -&gt; 0xfc9d
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	<span class="o">(</span><span class="nb">exit</span><span class="o">)</span> 
</span></span><span class="line"><span class="cl"><span class="o">[=]</span> 	exit_group<span class="o">(</span><span class="nv">code</span> <span class="o">=</span> 0x0<span class="o">)</span> <span class="o">=</span> ?
</span></span></code></pre></div><p>Et l√† le d√©codage est sensiblement le m√™me que pour le code pack√©, la fonction <code>check_key</code> va d√©chiffrer 24 octets avec les 4 octets de notre input, et vu que notre tracer nous permet d&rsquo;avoir acc√®s directement aux valeurs qui vont √™tre XOR√©s en les lisant pendant l&rsquo;ex√©cution, on retrouve le flag en utilisant son format connu (<code>404C</code>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">enc</span> <span class="o">=</span> <span class="mh">0x28570444</span>
</span></span><span class="line"><span class="cl"><span class="n">plain</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;404C&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">plain</span><span class="p">,</span> <span class="s2">&#34;little&#34;</span><span class="p">)</span> <span class="o">^</span> <span class="n">enc</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&#34;little&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># p4ck</span>
</span></span></code></pre></div><p>Et une fois qu&rsquo;on a trouv√© le mot de passe:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./vm reverse_my_vm.vmr 
</span></span><span class="line"><span class="cl">Please enter the key: b4ByG1rl
</span></span><span class="line"><span class="cl">Now, enter the passcode: p4ck
</span></span><span class="line"><span class="cl">Congrats! Your flag is: 404CTF<span class="o">{</span>P4ck1ng_1s_H3ll!<span class="o">}</span>
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>Cette VM √©tait tr√®s classique mais je trouvais ca tout de m√™me int√©ressant de solve ce challenge avec un framework d&rsquo;√©mulation comme Qiling dans l&rsquo;optique de faire un outil de tracing personalis√© pour l&rsquo;architecture utilis√©e par la VM üôÇ.</p>
<p>Code complet du tracer:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">qiling</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">qiling.const</span> <span class="kn">import</span> <span class="n">QL_VERBOSE</span><span class="p">,</span> <span class="n">QL_INTERCEPT</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">unicorn.unicorn_const</span> <span class="kn">import</span> <span class="n">UC_MEM_WRITE</span><span class="p">,</span> <span class="n">UC_MEM_READ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BASE</span> <span class="o">=</span> <span class="mh">0x555555554000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">REGS_SYMBOLS</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x50f0</span><span class="p">:</span> <span class="s2">&#34;A&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x50f4</span><span class="p">:</span> <span class="s2">&#34;B&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x50f8</span><span class="p">:</span> <span class="s2">&#34;R0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x50fc</span><span class="p">:</span> <span class="s2">&#34;R1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x5100</span><span class="p">:</span> <span class="s2">&#34;R2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x5104</span><span class="p">:</span> <span class="s2">&#34;R3&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x5108</span><span class="p">:</span> <span class="s2">&#34;PC&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x50a8</span><span class="p">:</span> <span class="s2">&#34;SP&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HANDLERS</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x15ee</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;jz&#39;</span><span class="p">,</span> <span class="s2">&#34;adr&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1705</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x17e5</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;sub&#39;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x18c5</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;and&#39;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x19a5</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;xor&#39;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x209f</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="s2">&#34;func&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x14f6</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1bcf</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;mov&#39;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span> <span class="p">,</span><span class="s2">&#34;adr&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1ca3</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;mov&#39;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1d20</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;jmp&#39;</span><span class="p">,</span> <span class="s2">&#34;adr&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1df8</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;push&#39;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1e86</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;pop&#39;</span><span class="p">,</span> <span class="s2">&#34;reg&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1544</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1550</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x155c</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;readfile&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x1563</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">STACK</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">LAST_ACCESS_REGS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">LAST_ACCESS_MEM</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hook_register_access</span><span class="p">(</span><span class="n">ql</span><span class="p">:</span> <span class="n">Qiling</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">reg</span> <span class="o">=</span> <span class="n">ql</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&#34;RAX&#34;</span><span class="p">)</span> <span class="o">-</span> <span class="n">BASE</span>
</span></span><span class="line"><span class="cl">    <span class="n">LAST_ACCESS_REGS</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hook_memory_access</span><span class="p">(</span><span class="n">ql</span><span class="p">:</span> <span class="n">Qiling</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">mem</span> <span class="o">=</span> <span class="n">ql</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&#34;RDI&#34;</span><span class="p">)</span> <span class="o">-</span> <span class="n">BASE</span>
</span></span><span class="line"><span class="cl">    <span class="n">LAST_ACCESS_MEM</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hook_stackframes</span><span class="p">(</span><span class="n">ql</span><span class="p">:</span> <span class="n">Qiling</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">func_name</span> <span class="o">=</span> <span class="n">ql</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="n">ql</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&#34;RDI&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">STACK</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hook_handlers</span><span class="p">(</span><span class="n">ql</span><span class="p">:</span> <span class="n">Qiling</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">rip</span> <span class="o">=</span> <span class="n">ql</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">rip</span> <span class="o">-</span> <span class="n">BASE</span>
</span></span><span class="line"><span class="cl">    <span class="n">handler</span> <span class="o">=</span> <span class="n">HANDLERS</span><span class="p">[</span><span class="n">rip</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#Parsing parameters, if DEBUG print value at runtime</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># If no more parameters</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">handler</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">handler</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;adr&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># If operand is a memory address</span>
</span></span><span class="line"><span class="cl">            <span class="n">ptr</span> <span class="o">=</span> <span class="n">LAST_ACCESS_MEM</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span><span class="si">}</span><span class="s2">]&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">handler</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;reg&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># If operand is a registers</span>
</span></span><span class="line"><span class="cl">            <span class="n">ptr</span> <span class="o">=</span> <span class="n">LAST_ACCESS_REGS</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span> <span class="o">=</span> <span class="n">REGS_SYMBOLS</span><span class="p">[</span><span class="n">ptr</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">handler</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;func&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># If operand is a function name (ptr is PC address)</span>
</span></span><span class="line"><span class="cl">            <span class="n">ptr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REGS_SYMBOLS</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="nb">list</span><span class="p">(</span><span class="n">REGS_SYMBOLS</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&#34;PC&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span> <span class="o">=</span> <span class="n">STACK</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&#34; -&gt; </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">ql</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">BASE</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ql</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;(</span><span class="si">{</span><span class="n">handler</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="s1">&#39; , &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">fix_qiling</span><span class="p">(</span><span class="n">ql</span><span class="p">:</span> <span class="n">Qiling</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Patching ld-2.35.so ISA check</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">by_pass_isa_check</span><span class="p">(</span><span class="n">ql</span><span class="p">:</span> <span class="n">Qiling</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">ql</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="s1">&#39;=-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}</span><span class="s2">[Bypassing isa check]</span><span class="si">{</span><span class="s1">&#39;=-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ql</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">rip</span> <span class="o">+=</span> <span class="mh">0x15</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ld_so_base</span> <span class="o">=</span> <span class="mh">0x7FFFF7DD5000</span>
</span></span><span class="line"><span class="cl">    <span class="n">ql</span><span class="o">.</span><span class="n">hook_address</span><span class="p">(</span><span class="n">by_pass_isa_check</span><span class="p">,</span> <span class="n">ld_so_base</span> <span class="o">+</span> <span class="mh">0x2389F</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Patching rseq not found</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">null_rseq_impl</span><span class="p">(</span><span class="n">ql</span><span class="p">:</span> <span class="n">Qiling</span><span class="p">,</span> <span class="n">abi</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sig</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">ql</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="s1">&#39;=-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}</span><span class="s2">[Bypassing rseq not found]</span><span class="si">{</span><span class="s1">&#39;=-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ql</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">set_syscall</span><span class="p">(</span><span class="s2">&#34;rseq&#34;</span><span class="p">,</span> <span class="n">null_rseq_impl</span><span class="p">,</span> <span class="n">QL_INTERCEPT</span><span class="o">.</span><span class="n">CALL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># patching prctl code 0x3001 not found</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">__no_cet</span><span class="p">(</span><span class="n">ql</span><span class="p">:</span> <span class="n">Qiling</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">retval</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ql</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="s1">&#39;=-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}</span><span class="s2">[Bypassig prctl code not found]</span><span class="si">{</span><span class="s1">&#39;=-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mh">0x3001</span> <span class="k">else</span> <span class="n">retval</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ql</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">set_syscall</span><span class="p">(</span><span class="s1">&#39;arch_prctl&#39;</span><span class="p">,</span> <span class="n">__no_cet</span><span class="p">,</span> <span class="n">QL_INTERCEPT</span><span class="o">.</span><span class="n">EXIT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hook_vm_start</span><span class="p">(</span><span class="n">ql</span><span class="p">:</span> <span class="n">Qiling</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">ql</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="s1">&#39;=-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}</span><span class="s2">[VM started]</span><span class="si">{</span><span class="s1">&#39;=-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Qiling init</span>
</span></span><span class="line"><span class="cl">    <span class="n">ql</span> <span class="o">=</span> <span class="n">Qiling</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;/home/mitenka/Bureau/CTF_TEMP/404_CTF/RE/vm&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;/home/mitenka/Bureau/CTF_TEMP/404_CTF/RE/reverse_my_vm.vmr&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">verbose</span><span class="o">=</span><span class="n">QL_VERBOSE</span><span class="o">.</span><span class="n">DEFAULT</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">vm_start_offset</span> <span class="o">=</span> <span class="mh">0x1404</span>
</span></span><span class="line"><span class="cl">    <span class="n">register_bank_access_ret</span> <span class="o">=</span> <span class="mh">0x2383</span>
</span></span><span class="line"><span class="cl">    <span class="n">memory_access_ret</span> <span class="o">=</span> <span class="mh">0x239b</span>
</span></span><span class="line"><span class="cl">    <span class="n">func_finder_prolog</span> <span class="o">=</span> <span class="mh">0x208c</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># I hate qiling</span>
</span></span><span class="line"><span class="cl">    <span class="n">fix_qiling</span><span class="p">(</span><span class="n">ql</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ql</span><span class="o">.</span><span class="n">hook_address</span><span class="p">(</span><span class="n">hook_vm_start</span><span class="p">,</span> <span class="n">BASE</span> <span class="o">+</span> <span class="n">vm_start_offset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1"># Hooking virtual registers access</span>
</span></span><span class="line"><span class="cl">    <span class="n">ql</span><span class="o">.</span><span class="n">hook_address</span><span class="p">(</span><span class="n">hook_register_access</span><span class="p">,</span> <span class="n">register_bank_access_ret</span> <span class="o">+</span> <span class="n">BASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Hooking memory access</span>
</span></span><span class="line"><span class="cl">    <span class="n">ql</span><span class="o">.</span><span class="n">hook_address</span><span class="p">(</span><span class="n">hook_memory_access</span><span class="p">,</span> <span class="n">memory_access_ret</span> <span class="o">+</span> <span class="n">BASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Hooking function finder</span>
</span></span><span class="line"><span class="cl">    <span class="n">ql</span><span class="o">.</span><span class="n">hook_address</span><span class="p">(</span><span class="n">hook_stackframes</span><span class="p">,</span> <span class="n">func_finder_prolog</span> <span class="o">+</span> <span class="n">BASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Hooking handlers</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">HANDLERS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">ql</span><span class="o">.</span><span class="n">hook_address</span><span class="p">(</span><span class="n">hook_handlers</span><span class="p">,</span> <span class="n">BASE</span> <span class="o">+</span> <span class="n">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ql</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># program key / passcode : b4ByG1rl / p4ck</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div></div>
  
    <div class="mt-16">

</div>
  
</article>
      </div>
    </main><footer class="fixed left-0 bottom-0 w-full bg-base px-page-gutter">
  <div class="flex justify-center items-center h-footer-height">
    <div
      class="flex flex-row w-full max-w-content justify-between lowercase italic gap-3"
    >
      <nav>
        <ul class="flex text-md space-x-3 sm:space-x-6">
          
        </ul>
      </nav>
      <span class="text-muted hidden md:block">
        &copy;
        2024
        <a
          href="https://github.com/ntk148v/hugo-toigian"
          class="font-bold hover:underline"
          >hugo-toigian</a
        >
      </span>
      <div id="header-theme-button">
        <svg
          id="dark_mode_btn"
          class="hidden toolbox-btn"
          width="18px"
          height="18px"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"
          />
        </svg>
        <svg
          id="light_mode_btn"
          class="hidden toolbox-btn"
          width="18px"
          height="18px"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"
          />
        </svg>
      </div>
    </div>
  </div>
</footer>
</body>
</html>
